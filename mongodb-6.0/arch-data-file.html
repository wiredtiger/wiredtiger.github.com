<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Data File Format</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('arch-data-file.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Data File Format </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="arch_head"><table class="doxtable">
<tr>
<th rowspan="2" style="width:10%;"> <div><a href="arch-index.html"><img class="arch_thumbnail" src="wt_diagram.png" usemap="#wt_diagram_map" style="background-image: url(wt_diagram.png)"></a></div></th><th style="width:44%">Data Structures</th><th style="width:45%">Source Location</th></tr>
<map id="wt_diagram_map" name="wt_diagram_map">
<area shape="rect" id="id1" href="modules.html" title="modules.html" alt="" coords="248,128,283,144"/>
<area shape="rect" id="id2" href="arch-cache.html" title="arch-cache.html" alt="" coords="204,546,248,562"/>
<area shape="rect" id="id3" href="arch-cursor.html" title="arch-cursor.html" alt="" coords="234,224,280,240"/>
<area shape="rect" id="id4" href="arch-eviction.html" title="arch-eviction.html" alt="" coords="303,546,356,562"/>
<area shape="rect" id="id5" href="arch-logging.html" title="arch-logging.html" alt="" coords="388,650,443,666"/>
<area shape="rect" id="id6" href="arch-schema.html" title="arch-schema.html" alt="" coords="123,224,179,240"/>
<area shape="rect" id="id7" href="command_line.html" title="command_line.html" alt="" coords="374,23,430,39"/>
<area shape="rect" id="id8" href="arch-log-file.html" title="arch-log-file.html" alt="" coords="308,865,339,897"/>
<area shape="rect" id="id9" href="arch-metadata.html" title="arch-metadata.html" alt="" coords="25,328,89,344"/>
<area shape="rect" id="id10" href="arch-python.html" title="arch-python.html" alt="" coords="84,23,157,39"/>
<area shape="rect" id="id11" href="arch-snapshot.html" title="arch-snapshot.html" alt="" coords="297,441,371,457"/>
<area shape="rect" id="id12" href="arch-transaction.html" title="arch-transaction.html" alt="" coords="298,328,387,344"/>
<area shape="rect" id="id13" href="arch-hs.html" title="arch-hs.html" alt="" coords="93,642,140,674"/>
<area shape="rect" id="id14" href="arch-block.html" title="arch-block.html" alt="" coords="196,642,256,674"/>
<area shape="rect" id="id15" href="arch-dhandle.html" title="arch-dhandle.html" alt="" coords="144,320,205,352"/>
<area shape="rect" id="id16" href="arch-data-file.html" title="arch-data-file.html" alt="" coords="179,865,245,897"/>
<area shape="rect" id="id17" href="arch-row-column.html" title="arch-row-column.html" alt="" coords="117,433,205,465"/>
<area shape="rect" id="id18" href="arch-fs-os.html" title="arch-fs-os.html" alt="" coords="175,755,357,771"/>
</map>
<tr>
<td><code><code>WT_CELL</code></code></td><td><code><code>src/include/block.h<br  />
src/include/btmem.h<br  />
src/include/cell.h<br  />
src/include/cell_inline.h<br  />
src/reconcile/rec_col.c<br  />
src/reconcile/rec_row.c</code></code></td></tr>
</table>
</div><p> <b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<h1><a class="anchor" id="data_file_database_files"></a>
Database Files</h1>
<p>WiredTiger stores databases in a durable format through writing data to files it has created in the database directory. These include data files representing tables in a MongoDB database, a history store file used to track previous versions of the database tables, as well as other metadata files for the entire system.</p>
<p>Data files are denoted by the .wt suffix. The history store file (WiredTigerHS.wt) and the metadata file (WiredTiger.wt) are special WiredTiger files, but have the same underlying structure as normal data files.</p>
<h1><a class="anchor" id="data_file_format"></a>
Data File Format and Layout</h1>
<p>In memory, a database table is represented by a B-Tree data structure, which is made up of nodes that are page structures. The root and internal pages will only store keys and references to other pages, while leaf pages store keys, values and sometimes references to overflow pages. When these pages are written onto the disk, they are written out as units of data called blocks. On the disk, a WiredTiger data file is just a collection of blocks which logically represent the pages of the B-Tree.</p>
<p>The layout of a .wt file consists of a file description <code>WT_BLOCK_DESC</code> which always occupies the first block, followed by a set of on-disk pages. The file description contains metadata about the file such as the WiredTiger major and minor version, a magic number, and a checksum of the block contents. This information is used to verify that the file is a legitimate WiredTiger data file with a compatible WiredTiger version, and that its contents are not corrupted.</p>
<h1><a class="anchor" id="data_file_on_disk_page_format"></a>
On-Disk Page Format and Layout</h1>
<p>Pages consist of a header (<code>WT_PAGE_HEADER</code> and <code>WT_BLOCK_HEADER</code>) followed by a variable number of cells, which encode keys, values or addresses (see <code>cell.h</code>). The page header <code>WT_PAGE_HEADER</code> consists of information such as the column-store record number, write generation (required for ordering pages in time), in-memory size, cell count (the number of cells on the page), data length (the overflow record length), and the page type. This is immediately followed by the block header <code>WT_BLOCK_HEADER</code> which contains block-manager specific information such as flags and version.</p>
<p>After the page header, pages with variable-length keys or values will have a set of cells. There are four main types of cells - keys, data, deleted cells, and off-page references. Cells are also usually followed by some additional data depending on its type. For example, values may have a time validity window, and off-page references may have a validity window and an address cookie. Ordering is important, values are all associated with the key that precedes them. Multiple values may be present, which can represent multiple versions. Extremely large values may be represented as a reference to another page (see overflow pages).</p>
<p>Fixed-length column store pages contain a block of bitmap data after the page header; after this there may be an auxiliary header followed by zero or more cells that are used to hold any auxiliary data (currently, time validity windows) associated with the values in the bitmap.</p>
<p>The exact encoding of cells is rather complex, and beyond what can be described here. The encoding strikes a balance between data that can be compacted efficiently in time and space, extensibility, and compatibility with previous versions.</p>
<h1><a class="anchor" id="data_file_page_types"></a>
Page Types</h1>
<p>Different types of pages are made up of different types of cells.</p>
<p>(1) Internal Pages - as the B-Tree grows in size and layer/s are added, there will be pages between the root page and leaf page. These internal pages contain keys that point to other pages.</p><ul>
<li>The row-store internal page <code>WT_PAGE_ROW_INT</code> is made up of a key cell (<code>WT_CELL_KEY</code> or <code>WT_CELL_KEY_OVFL</code>) followed by an off-page reference (<code>WT_CELL_ADDR_XXX</code>).</li>
<li>The column-store internal page <code>WT_PAGE_COL_INT</code> simply contains an off-page reference.</li>
</ul>
<p>(2) Leaf Pages - leaf pages consist of a page header, followed by keys, values or addresses (these reference overflow pages).</p><ul>
<li>The row-store leaf page <code>WT_PAGE_ROW_LEAF</code> is made up of a key cell (<code>WT_CELL_KEY</code> or <code>WT_CELL_KEY_OVFL</code>) followed by a value (<code>WT_CELL_VALUE/VALUE_COPY/VALUE_OVFL</code>).</li>
<li>The variable-length column-store leaf page <code>WT_PAGE_COL_VAR</code> is made up of data cells (<code>WT_CELL_VALUE/VALUE_COPY/VALUE_OVFL</code>) or deleted cells (<code>WT_CELL_DEL</code>). The page header has a starting record number, so the associated keys for all column store values is deduced by their position in the page.</li>
<li>The fixed-length column store leaf page <code>WT_PAGE_COL_FIX</code> is made up of, first, a block of bitmap data, and then an auxiliary header followed by key cells (<code>WT_CELL_KEY</code>) alternating with value cells (<code>WT_CELL_VALUE</code>). The keys hold record number offsets from the page start; the value cells are always empty values, but include validity window information for values in the bitmap data. Cells for items with no validity window information are not written. Pages needing no validity window information at all do not contain the auxiliary header either.</li>
</ul>
<p>(3) Overflow Pages - overflow pages are needed when keys/values that are too large must be stored separately in the file, apart from where the item is logically placed. Page sizes and configuration values such as leaf_key_max and leaf_value_max are used to determine overflow items.</p>
<p>While the above gives a general overview of how different page types are structured, it is a simplified representation. Due to the large amount of data being stored, WiredTiger may compress data to preserve memory and disk space. Keys may not be stored in their entirety when prefix compression is used (the identical key prefix is stored only once per page to reduce size). In addition, each block written may be compressed and/or encrypted. The header portion of each block remains uncompressed and unencrypted.</p>
<h1><a class="anchor" id="data_file_functions"></a>
Data File Functions</h1>
<p>When data needs to be read from a data file, it is unpacked into in-memory structures, and vice versa, we pack the contents when we want to write a page image to a data file. Low level functions that pack or unpack the contents of individual cells are in <code>cell_inline.h</code>. Functions like <code>__wt_cell_unpack_kv</code> and <code>__wt_cell_unpack_addr</code> to unpack keys, values and addresses are found here, and uses of such functions appear in the B-Tree code. Similarly, there are <code>__wt_cell_pack_*</code> functions to pack particular kinds of keys, values and addresses; these are used in the reconciliation code. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-mem-disk.html">Moving Data Between Memory and Disk</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
