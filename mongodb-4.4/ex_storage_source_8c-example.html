<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: ex_storage_source.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.0</span>
   </div>
   <div id="projectbrief"><!-- 10.0.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ex_storage_source_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ex_storage_source.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Shows how to extend WiredTiger with a custom storage source implementation.</p>
<div class="fragment"><div class="line"><span class="comment">/*-</span></div><div class="line"><span class="comment"> * Public Domain 2014-present MongoDB, Inc.</span></div><div class="line"><span class="comment"> * Public Domain 2008-2014 WiredTiger, Inc.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This is free and unencumbered software released into the public domain.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Anyone is free to copy, modify, publish, use, compile, sell, or</span></div><div class="line"><span class="comment"> * distribute this software, either in source code form or as a compiled</span></div><div class="line"><span class="comment"> * binary, for any purpose, commercial or non-commercial, and by any</span></div><div class="line"><span class="comment"> * means.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * In jurisdictions that recognize copyright laws, the author or authors</span></div><div class="line"><span class="comment"> * of this software dedicate any and all copyright interest in the</span></div><div class="line"><span class="comment"> * software to the public domain. We make this dedication for the benefit</span></div><div class="line"><span class="comment"> * of the public at large and to the detriment of our heirs and</span></div><div class="line"><span class="comment"> * successors. We intend this dedication to be an overt act of</span></div><div class="line"><span class="comment"> * relinquishment in perpetuity of all present and future rights to this</span></div><div class="line"><span class="comment"> * software under copyright law.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span></div><div class="line"><span class="comment"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span></div><div class="line"><span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span></div><div class="line"><span class="comment"> * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span></div><div class="line"><span class="comment"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span></div><div class="line"><span class="comment"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span></div><div class="line"><span class="comment"> * OTHER DEALINGS IN THE SOFTWARE.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ex_storage_source.c</span></div><div class="line"><span class="comment"> *      demonstrates how to use the custom storage source interface</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#include &lt;test_util.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef __GNUC__</span></div><div class="line"><span class="preprocessor">#if __GNUC__ &gt; 7 || (__GNUC__ == 7 &amp;&amp; __GNUC_MINOR__ &gt; 0)</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * !!!</span></div><div class="line"><span class="comment"> * GCC with -Wformat-truncation complains about calls to snprintf in this file.</span></div><div class="line"><span class="comment"> * There&#39;s nothing wrong, this makes the warning go away.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wformat-truncation&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * This example code uses pthread functions for portable locking, we ignore errors for simplicity.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">allocate_storage_source_lock(pthread_rwlock_t *lockp)</div><div class="line">{</div><div class="line">    error_check(pthread_rwlock_init(lockp, NULL));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">destroy_storage_source_lock(pthread_rwlock_t *lockp)</div><div class="line">{</div><div class="line">    error_check(pthread_rwlock_destroy(lockp));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">lock_storage_source(pthread_rwlock_t *lockp)</div><div class="line">{</div><div class="line">    error_check(pthread_rwlock_wrlock(lockp));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">unlock_storage_source(pthread_rwlock_t *lockp)</div><div class="line">{</div><div class="line">    error_check(pthread_rwlock_unlock(lockp));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Example storage source implementation, using memory buffers to represent objects.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    WT_STORAGE_SOURCE iface;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * WiredTiger performs schema and I/O operations in parallel, all storage sources and file</span></div><div class="line"><span class="comment">     * handle access must be thread-safe. This example uses a single, global storage source lock for</span></div><div class="line"><span class="comment">     * simplicity; real applications might require finer granularity, for example, a single lock for</span></div><div class="line"><span class="comment">     * the storage source handle list and per-handle locks serializing I/O.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    pthread_rwlock_t lock; <span class="comment">/* Lock */</span></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> closed_object_count;</div><div class="line">    <span class="keywordtype">int</span> opened_object_count;</div><div class="line">    <span class="keywordtype">int</span> opened_unique_object_count;</div><div class="line">    <span class="keywordtype">int</span> read_ops;</div><div class="line">    <span class="keywordtype">int</span> write_ops;</div><div class="line"></div><div class="line">    <span class="comment">/* Queue of file handles */</span></div><div class="line">    TAILQ_HEAD(demo_file_handle_qh, demo_file_handle) fileq;</div><div class="line"></div><div class="line">    <a name="_a0"></a><a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext; <span class="comment">/* Extension functions */</span></div><div class="line"></div><div class="line">} DEMO_STORAGE_SOURCE;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>demo_file_handle {</div><div class="line">    <a name="_a1"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> iface;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Add custom file handle fields after the interface.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss; <span class="comment">/* Enclosing storage source */</span></div><div class="line"></div><div class="line">    TAILQ_ENTRY(demo_file_handle) q; <span class="comment">/* Queue of handles */</span></div><div class="line">    uint32_t ref;                    <span class="comment">/* Reference count */</span></div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> *buf;      <span class="comment">/* In-memory contents */</span></div><div class="line">    <span class="keywordtype">size_t</span> bufsize; <span class="comment">/* In-memory buffer size */</span></div><div class="line"></div><div class="line">    <span class="keywordtype">size_t</span> size; <span class="comment">/* Read/write data size */</span></div><div class="line">} DEMO_FILE_HANDLE;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>demo_location_handle {</div><div class="line">    WT_LOCATION_HANDLE iface;</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> *loc_string; <span class="comment">/* location as a string. */</span></div><div class="line">} DEMO_LOCATION_HANDLE;</div><div class="line"></div><div class="line"><span class="preprocessor">#define LOCATION_STRING(lh) (((DEMO_LOCATION_HANDLE *)lh)-&gt;loc_string)</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Extension initialization function.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#ifdef _WIN32</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Explicitly export this function so it is visible when loading extensions.</span></div><div class="line"><span class="comment"> */</span></div><div class="line">__declspec(dllexport)</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  <span class="keywordtype">int</span> demo_storage_source_create(<a name="_a2"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html">WT_CONNECTION</a> *, <a class="code" href="group__wt__ext.html#ga6fa5797cf581d18dc843e07333a497e4">WT_CONFIG_ARG</a> *);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Forward function declarations for storage source API implementation.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_exist(</div><div class="line">  WT_STORAGE_SOURCE *, <a name="_a3"></a><a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, WT_LOCATION_HANDLE *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, <span class="keywordtype">bool</span> *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_location_handle(</div><div class="line">  WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, WT_LOCATION_HANDLE **);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_location_list(WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, WT_LOCATION_HANDLE *,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *, uint32_t, <span class="keywordtype">char</span> ***, uint32_t *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_location_list_free(WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, <span class="keywordtype">char</span> **, uint32_t);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_open(WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, WT_LOCATION_HANDLE *, <span class="keyword">const</span> <span class="keywordtype">char</span> *,</div><div class="line">  uint32_t, <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> **);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_remove(</div><div class="line">  WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, WT_LOCATION_HANDLE *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, uint32_t);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_size(</div><div class="line">  WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, WT_LOCATION_HANDLE *, <span class="keyword">const</span> <span class="keywordtype">char</span> *, wt_off_t *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_ss_terminate(WT_STORAGE_SOURCE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Forward function declarations for location API implementation.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_location_close(WT_LOCATION_HANDLE *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Forward function declarations for file handle API implementation.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_close(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_lock(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, <span class="keywordtype">bool</span>);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_read(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, wt_off_t, <span class="keywordtype">size_t</span>, <span class="keywordtype">void</span> *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_size(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, wt_off_t *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_sync(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_truncate(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, wt_off_t);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_file_write(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, wt_off_t, <span class="keywordtype">size_t</span>, <span class="keyword">const</span> <span class="keywordtype">void</span> *);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Forward function declarations for internal functions.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> demo_handle_remove(<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *, DEMO_FILE_HANDLE *);</div><div class="line"><span class="keyword">static</span> DEMO_FILE_HANDLE *demo_handle_search(</div><div class="line">  WT_STORAGE_SOURCE *, WT_LOCATION_HANDLE *, <span class="keyword">const</span> <span class="keywordtype">char</span> *);</div><div class="line"></div><div class="line"><span class="preprocessor">#define DEMO_FILE_SIZE_INCREMENT 32768</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * string_match --</span></div><div class="line"><span class="comment"> *     Return if a string matches a byte string of len bytes.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div><div class="line">byte_string_match(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keyword">const</span> <span class="keywordtype">char</span> *bytes, <span class="keywordtype">size_t</span> len)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> (strncmp(str, bytes, len) == 0 &amp;&amp; (str)[(len)] == <span class="charliteral">&#39;\0&#39;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_storage_source_create --</span></div><div class="line"><span class="comment"> *     Initialize the demo storage source.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span></div><div class="line">demo_storage_source_create(<a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html">WT_CONNECTION</a> *conn, <a class="code" href="group__wt__ext.html#ga6fa5797cf581d18dc843e07333a497e4">WT_CONFIG_ARG</a> *config)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a name="_a4"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html">WT_CONFIG_ITEM</a> k, v;</div><div class="line">    <a name="_a5"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___p_a_r_s_e_r.html">WT_CONFIG_PARSER</a> *config_parser;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line">    WT_STORAGE_SOURCE *storage_source;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    wtext = conn-&gt;<a name="a6"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a99df5b3a17564eb5b3e4ec076590133d">get_extension_api</a>(conn);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((demo_ss = calloc(1, <span class="keyword">sizeof</span>(DEMO_STORAGE_SOURCE))) == NULL) {</div><div class="line">        (void)wtext-&gt;<a name="a7"></a><a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(</div><div class="line">          wtext, NULL, <span class="stringliteral">&quot;demo_storage_source_create: %s&quot;</span>, wtext-&gt;<a name="a8"></a><a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ENOMEM));</div><div class="line">        <span class="keywordflow">return</span> (ENOMEM);</div><div class="line">    }</div><div class="line">    demo_ss-&gt;wtext = wtext;</div><div class="line">    storage_source = (WT_STORAGE_SOURCE *)demo_ss;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Applications may have their own configuration information to pass to the underlying</span></div><div class="line"><span class="comment">     * filesystem implementation. See the main function for the setup of those configuration</span></div><div class="line"><span class="comment">     * strings; here we parse configuration information as passed in by main, through WiredTiger.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = wtext-&gt;<a name="a9"></a><a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#ae498b02cf83cdb644c2665c37917e785">config_parser_open_arg</a>(wtext, NULL, config, &amp;config_parser)) != 0) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, NULL, <span class="stringliteral">&quot;WT_EXTENSION_API.config_parser_open: config: %s&quot;</span>,</div><div class="line">          wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Step through our configuration values. */</span></div><div class="line">    printf(<span class="stringliteral">&quot;Custom storage source configuration\n&quot;</span>);</div><div class="line">    <span class="keywordflow">while</span> ((ret = config_parser-&gt;<a name="a10"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___p_a_r_s_e_r.html#a2033bdd009b0a75ade51305f00a7dc8f">next</a>(config_parser, &amp;k, &amp;v)) == 0) {</div><div class="line">        <span class="keywordflow">if</span> (byte_string_match(<span class="stringliteral">&quot;config_string&quot;</span>, k.<a name="a11"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, k.<a name="a12"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>)) {</div><div class="line">            printf(</div><div class="line">              <span class="stringliteral">&quot;\t&quot;</span></div><div class="line">              <span class="stringliteral">&quot;key %.*s=\&quot;%.*s\&quot;\n&quot;</span>,</div><div class="line">              (<span class="keywordtype">int</span>)k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>, k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, (<span class="keywordtype">int</span>)v.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>, v.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (byte_string_match(<span class="stringliteral">&quot;config_value&quot;</span>, k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>)) {</div><div class="line">            printf(</div><div class="line">              <span class="stringliteral">&quot;\t&quot;</span></div><div class="line">              <span class="stringliteral">&quot;key %.*s=%&quot;</span> PRId64 <span class="stringliteral">&quot;\n&quot;</span>,</div><div class="line">              (<span class="keywordtype">int</span>)k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>, k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, v.<a name="a13"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#a4aefab7843f434e5a5cc18203e9fec5f">val</a>);</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        }</div><div class="line">        ret = EINVAL;</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, NULL,</div><div class="line">          <span class="stringliteral">&quot;WT_CONFIG_PARSER.next: unexpected configuration &quot;</span></div><div class="line">          <span class="stringliteral">&quot;information: %.*s=%.*s: %s&quot;</span>,</div><div class="line">          (<span class="keywordtype">int</span>)k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>, k.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, (<span class="keywordtype">int</span>)v.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#adff0f6e5a3f781f0228015e8336f1a14">len</a>, v.<a class="code" href="struct_w_t___c_o_n_f_i_g___i_t_e_m.html#aa0ce7d30a32600e16824966c638ee45f">str</a>, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Check for expected parser termination and close the parser. */</span></div><div class="line">    <span class="keywordflow">if</span> (ret != <a name="a14"></a><a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(</div><div class="line">          wtext, NULL, <span class="stringliteral">&quot;WT_CONFIG_PARSER.next: config: %s&quot;</span>, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> ((ret = config_parser-&gt;<a name="a15"></a><a class="code" href="struct_w_t___c_o_n_f_i_g___p_a_r_s_e_r.html#a44eea5e27a4da10006ab444ee7cf00f3">close</a>(config_parser)) != 0) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(</div><div class="line">          wtext, NULL, <span class="stringliteral">&quot;WT_CONFIG_PARSER.close: config: %s&quot;</span>, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    allocate_storage_source_lock(&amp;demo_ss-&gt;lock);</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the in-memory jump table. */</span></div><div class="line">    storage_source-&gt;ss_exist = demo_ss_exist;</div><div class="line">    storage_source-&gt;ss_location_handle = demo_ss_location_handle;</div><div class="line">    storage_source-&gt;ss_location_list = demo_ss_location_list;</div><div class="line">    storage_source-&gt;ss_location_list_free = demo_ss_location_list_free;</div><div class="line">    storage_source-&gt;ss_open_object = demo_ss_open;</div><div class="line">    storage_source-&gt;ss_remove = demo_ss_remove;</div><div class="line">    storage_source-&gt;ss_size = demo_ss_size;</div><div class="line">    storage_source-&gt;terminate = demo_ss_terminate;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((ret = conn-&gt;add_storage_source(conn, <span class="stringliteral">&quot;demo&quot;</span>, storage_source, NULL)) != 0) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(</div><div class="line">          wtext, NULL, <span class="stringliteral">&quot;WT_CONNECTION.set_storage_source: %s&quot;</span>, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line"></div><div class="line">err:</div><div class="line">    free(demo_ss);</div><div class="line">    <span class="comment">/* An error installing the storage source is fatal. */</span></div><div class="line">    exit(1);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_open --</span></div><div class="line"><span class="comment"> *     fopen for our demo storage source.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_open(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, uint32_t flags,</div><div class="line">  <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> **file_handlep)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line">    <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *location;</div><div class="line">    <span class="keywordtype">char</span> *full_name;</div><div class="line">    <span class="keywordtype">size_t</span> name_len;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    (void)flags; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    *file_handlep = NULL;</div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line">    demo_fh = NULL;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    ++demo_ss-&gt;opened_object_count;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * First search the file queue, if we find it, assert there&#39;s only a single reference, we only</span></div><div class="line"><span class="comment">     * support a single handle on any file.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    demo_fh = demo_handle_search(storage_source, location_handle, name);</div><div class="line">    <span class="keywordflow">if</span> (demo_fh != NULL) {</div><div class="line">        <span class="keywordflow">if</span> (demo_fh-&gt;ref != 0) {</div><div class="line">            (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session, <span class="stringliteral">&quot;demo_ss_open: %s: file already open&quot;</span>, name);</div><div class="line">            ret = EBUSY;</div><div class="line">            <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        demo_fh-&gt;ref = 1;</div><div class="line">        *file_handlep = (<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *)demo_fh;</div><div class="line">        unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* The file hasn&#39;t been opened before, create a new one. */</span></div><div class="line">    <span class="keywordflow">if</span> ((demo_fh = calloc(1, <span class="keyword">sizeof</span>(DEMO_FILE_HANDLE))) == NULL) {</div><div class="line">        ret = ENOMEM;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize private information. */</span></div><div class="line">    demo_fh-&gt;demo_ss = demo_ss;</div><div class="line">    demo_fh-&gt;ref = 1;</div><div class="line">    <span class="keywordflow">if</span> ((demo_fh-&gt;buf = calloc(1, DEMO_FILE_SIZE_INCREMENT)) == NULL) {</div><div class="line">        ret = ENOMEM;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    demo_fh-&gt;bufsize = DEMO_FILE_SIZE_INCREMENT;</div><div class="line">    demo_fh-&gt;size = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Construct the public name. */</span></div><div class="line">    location = LOCATION_STRING(location_handle);</div><div class="line">    name_len = strlen(location) + strlen(name) + 1;</div><div class="line">    full_name = calloc(1, name_len);</div><div class="line">    <span class="keywordflow">if</span> (snprintf(full_name, name_len, <span class="stringliteral">&quot;%s%s&quot;</span>, location, name) != (ssize_t)(name_len - 1)) {</div><div class="line">        ret = ENOMEM;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize public information. */</span></div><div class="line">    file_handle = (<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *)demo_fh;</div><div class="line">    file_handle-&gt;<a name="a16"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ad2a2c8838d62efa219404eeb006bddd5">name</a> = full_name;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Setup the function call table for our custom storage source. Set the function pointer to NULL</span></div><div class="line"><span class="comment">     * where our implementation doesn&#39;t support the functionality.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    file_handle-&gt;<a name="a17"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#aa4376c70336f8a0bbd8bf1c91749aeed">close</a> = demo_file_close;</div><div class="line">    file_handle-&gt;<a name="a18"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a5b68b388279c64add7b0ef893b1d2e00">fh_advise</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a19"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ab4b685446f0ce09b7270dd32bb771ce7">fh_extend</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a20"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a2479acb713a211b2d7cc84aaada4b29b">fh_extend_nolock</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a21"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a5db2aa421c5297d9119b9517e1117afb">fh_lock</a> = demo_file_lock;</div><div class="line">    file_handle-&gt;<a name="a22"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#afaf6ca726275db6772700eaca399c89f">fh_map</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a23"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a02b0e75636d323ce5bd42fdf7e83615e">fh_map_discard</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a24"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a350e1db2cd51c8c2479b03beae9af90f">fh_map_preload</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a25"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ad41718cb1f7a59cfb21a68785aa09897">fh_read</a> = demo_file_read;</div><div class="line">    file_handle-&gt;<a name="a26"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a1e0b90f0a4fcf943e81b22b94069738b">fh_size</a> = demo_file_size;</div><div class="line">    file_handle-&gt;<a name="a27"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ad4f3371981540000e182ed0cb75eefad">fh_sync</a> = demo_file_sync;</div><div class="line">    file_handle-&gt;<a name="a28"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ad4203cea23fd8f62765564ba9a24fe6c">fh_sync_nowait</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a29"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#aadcd969865c263c9e9b00d39308e296c">fh_truncate</a> = demo_file_truncate;</div><div class="line">    file_handle-&gt;<a name="a30"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a9e8786a0eedb67d92a9e8e5239faef6b">fh_unmap</a> = NULL;</div><div class="line">    file_handle-&gt;<a name="a31"></a><a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ab69c295b076627307a6528793d7a9b43">fh_write</a> = demo_file_write;</div><div class="line"></div><div class="line">    TAILQ_INSERT_HEAD(&amp;demo_ss-&gt;fileq, demo_fh, q);</div><div class="line">    ++demo_ss-&gt;opened_unique_object_count;</div><div class="line"></div><div class="line">    *file_handlep = file_handle;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (0) {</div><div class="line">err:</div><div class="line">        free(demo_fh-&gt;buf);</div><div class="line">        free(demo_fh);</div><div class="line">    }</div><div class="line"></div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_location_handle --</span></div><div class="line"><span class="comment"> *     Return a location handle from a location string.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_location_handle(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *location_info, WT_LOCATION_HANDLE **location_handlep)</div><div class="line">{</div><div class="line">    DEMO_LOCATION_HANDLE *demo_loc;</div><div class="line">    <span class="keywordtype">size_t</span> len;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <span class="keywordtype">char</span> *p;</div><div class="line"></div><div class="line">    (void)storage_source; <span class="comment">/* Unused */</span></div><div class="line">    (void)session;        <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    ret = 0;</div><div class="line">    p = NULL;</div><div class="line">    demo_loc = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * We save the location string we&#39;re given followed by a slash delimiter. We won&#39;t allow slashes</span></div><div class="line"><span class="comment">     * in the location info parameter.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> (strchr(location_info, <span class="charliteral">&#39;/&#39;</span>) != NULL)</div><div class="line">        <span class="keywordflow">return</span> (EINVAL);</div><div class="line">    len = strlen(location_info) + 2;</div><div class="line">    p = malloc(len);</div><div class="line">    <span class="keywordflow">if</span> (snprintf(p, len, <span class="stringliteral">&quot;%s/&quot;</span>, location_info) != (ssize_t)(len - 1)) {</div><div class="line">        ret = ENOMEM;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Now create the location handle and save the string.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((demo_loc = calloc(1, <span class="keyword">sizeof</span>(DEMO_LOCATION_HANDLE))) == NULL) {</div><div class="line">        ret = ENOMEM;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize private information. */</span></div><div class="line">    demo_loc-&gt;loc_string = p;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize public information. */</span></div><div class="line">    demo_loc-&gt;iface.close = demo_location_close;</div><div class="line"></div><div class="line">    *location_handlep = &amp;demo_loc-&gt;iface;</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div><div class="line">        free(p);</div><div class="line">        free(demo_loc);</div><div class="line">        <span class="keywordflow">return</span> (ret);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_location_list --</span></div><div class="line"><span class="comment"> *     Return a list of object names for the given location.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_location_list(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *prefix, uint32_t limit, <span class="keywordtype">char</span> ***dirlistp,</div><div class="line">  uint32_t *countp)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <span class="keywordtype">size_t</span> location_len, prefix_len;</div><div class="line">    uint32_t allocated, count;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *location;</div><div class="line">    <span class="keywordtype">char</span> **entries, *name;</div><div class="line">    <span class="keywordtype">void</span> *p;</div><div class="line"></div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line"></div><div class="line">    *dirlistp = NULL;</div><div class="line">    *countp = 0;</div><div class="line"></div><div class="line">    entries = NULL;</div><div class="line">    allocated = count = 0;</div><div class="line">    location = LOCATION_STRING(location_handle);</div><div class="line">    location_len = strlen(location);</div><div class="line">    prefix_len = (prefix == NULL ? 0 : strlen(prefix));</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    TAILQ_FOREACH (demo_fh, &amp;demo_ss-&gt;fileq, q) {</div><div class="line">        name = demo_fh-&gt;iface.name;</div><div class="line">        <span class="keywordflow">if</span> (strncmp(name, location, location_len) != 0)</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line">        name += location_len;</div><div class="line">        <span class="keywordflow">if</span> (prefix != NULL &amp;&amp; strncmp(name, prefix, prefix_len) != 0)</div><div class="line">            <span class="keywordflow">continue</span>;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Increase the list size in groups of 10, it doesn&#39;t matter if the list is a bit longer</span></div><div class="line"><span class="comment">         * than necessary.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keywordflow">if</span> (count &gt;= allocated) {</div><div class="line">            p = realloc(entries, (allocated + 10) * <span class="keyword">sizeof</span>(*entries));</div><div class="line">            <span class="keywordflow">if</span> (p == NULL) {</div><div class="line">                ret = ENOMEM;</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">            }</div><div class="line"></div><div class="line">            entries = p;</div><div class="line">            memset(entries + allocated * <span class="keyword">sizeof</span>(*entries), 0, 10 * <span class="keyword">sizeof</span>(*entries));</div><div class="line">            allocated += 10;</div><div class="line">        }</div><div class="line">        entries[count++] = strdup(name);</div><div class="line">        <span class="keywordflow">if</span> (limit &gt; 0 &amp;&amp; count &gt;= limit)</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    *dirlistp = entries;</div><div class="line">    *countp = count;</div><div class="line"></div><div class="line">err:</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> (ret == 0)</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (entries != NULL) {</div><div class="line">        <span class="keywordflow">while</span> (count &gt; 0)</div><div class="line">            free(entries[--count]);</div><div class="line">        free(entries);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_location_list_free --</span></div><div class="line"><span class="comment"> *     Free memory allocated by demo_ss_location_list.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_location_list_free(</div><div class="line">  WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, <span class="keywordtype">char</span> **dirlist, uint32_t count)</div><div class="line">{</div><div class="line">    (void)storage_source;</div><div class="line">    (void)session;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (dirlist != NULL) {</div><div class="line">        <span class="keywordflow">while</span> (count &gt; 0)</div><div class="line">            free(dirlist[--count]);</div><div class="line">        free(dirlist);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_exist --</span></div><div class="line"><span class="comment"> *     Return if the file exists.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_exist(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">bool</span> *existp)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line"></div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    *existp = demo_handle_search(storage_source, location_handle, name) != NULL;</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_remove --</span></div><div class="line"><span class="comment"> *     POSIX remove.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_remove(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, uint32_t flags)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line">    (void)flags;   <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line"></div><div class="line">    ret = ENOENT;</div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> ((demo_fh = demo_handle_search(storage_source, location_handle, name)) != NULL)</div><div class="line">        ret = demo_handle_remove(session, demo_fh);</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_size --</span></div><div class="line"><span class="comment"> *     Get the size of a file in bytes, by file name.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_size(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session,</div><div class="line">  WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, wt_off_t *sizep)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line"></div><div class="line">    ret = ENOENT;</div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> ((demo_fh = demo_handle_search(storage_source, location_handle, name)) != NULL)</div><div class="line">        ret = demo_file_size((<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *)demo_fh, session, sizep);</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_ss_terminate --</span></div><div class="line"><span class="comment"> *     Discard any resources on termination.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_ss_terminate(WT_STORAGE_SOURCE *storage_source, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh, *demo_fh_tmp;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <span class="keywordtype">int</span> ret = 0, tret;</div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line"></div><div class="line">    TAILQ_FOREACH_SAFE(demo_fh, &amp;demo_ss-&gt;fileq, q, demo_fh_tmp)</div><div class="line">    <span class="keywordflow">if</span> ((tret = demo_handle_remove(session, demo_fh)) != 0 &amp;&amp; ret == 0)</div><div class="line">        ret = tret;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Custom storage source\n&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;\t%d unique object opens\n&quot;</span>, demo_ss-&gt;opened_unique_object_count);</div><div class="line">    printf(<span class="stringliteral">&quot;\t%d objects opened\n&quot;</span>, demo_ss-&gt;opened_object_count);</div><div class="line">    printf(<span class="stringliteral">&quot;\t%d objects closed\n&quot;</span>, demo_ss-&gt;closed_object_count);</div><div class="line">    printf(<span class="stringliteral">&quot;\t%d reads, %d writes\n&quot;</span>, demo_ss-&gt;read_ops, demo_ss-&gt;write_ops);</div><div class="line"></div><div class="line">    destroy_storage_source_lock(&amp;demo_ss-&gt;lock);</div><div class="line">    free(demo_ss);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_location_close --</span></div><div class="line"><span class="comment"> *     Free a location handle created by ss_location_handle.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_location_close(WT_LOCATION_HANDLE *location_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session)</div><div class="line">{</div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    free(LOCATION_STRING(location_handle));</div><div class="line">    free(location_handle);</div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_close --</span></div><div class="line"><span class="comment"> *     ANSI C close.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_close(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line"></div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_fh = (DEMO_FILE_HANDLE *)file_handle;</div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> (--demo_fh-&gt;ref == 0)</div><div class="line">        ++demo_ss-&gt;closed_object_count;</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_lock --</span></div><div class="line"><span class="comment"> *     Lock/unlock a file.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_lock(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, <span class="keywordtype">bool</span> lock)</div><div class="line">{</div><div class="line">    <span class="comment">/* Locks are always granted. */</span></div><div class="line">    (void)file_handle; <span class="comment">/* Unused */</span></div><div class="line">    (void)session;     <span class="comment">/* Unused */</span></div><div class="line">    (void)lock;        <span class="comment">/* Unused */</span></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_read --</span></div><div class="line"><span class="comment"> *     POSIX pread.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_read(</div><div class="line">  <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, wt_off_t offset, <span class="keywordtype">size_t</span> len, <span class="keywordtype">void</span> *buf)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line">    <span class="keywordtype">size_t</span> off;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    demo_fh = (DEMO_FILE_HANDLE *)file_handle;</div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line">    off = (size_t)offset;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    ++demo_ss-&gt;read_ops;</div><div class="line">    <span class="keywordflow">if</span> (off &lt; demo_fh-&gt;size) {</div><div class="line">        <span class="keywordflow">if</span> (len &gt; demo_fh-&gt;size - off)</div><div class="line">            len = demo_fh-&gt;size - off;</div><div class="line">        memcpy(buf, (uint8_t *)demo_fh-&gt;buf + off, len);</div><div class="line">    } <span class="keywordflow">else</span></div><div class="line">        ret = EIO; <span class="comment">/* EOF */</span></div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> (ret == 0)</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line"></div><div class="line">    (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session,</div><div class="line">      <span class="stringliteral">&quot;%s: handle-read: failed to read %zu bytes at offset %zu: %s&quot;</span>, demo_fh-&gt;iface.name, len, off,</div><div class="line">      wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_size --</span></div><div class="line"><span class="comment"> *     Get the size of a file in bytes, by file handle.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_size(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, wt_off_t *sizep)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line"></div><div class="line">    (void)session; <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_fh = (DEMO_FILE_HANDLE *)file_handle;</div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    *sizep = (wt_off_t)demo_fh-&gt;size;</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_sync --</span></div><div class="line"><span class="comment"> *     Ensure the content of the file is stable. This is a no-op in our memory backed storage</span></div><div class="line"><span class="comment"> *     source.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_sync(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session)</div><div class="line">{</div><div class="line">    (void)file_handle; <span class="comment">/* Unused */</span></div><div class="line">    (void)session;     <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_buffer_resize --</span></div><div class="line"><span class="comment"> *     Resize the write buffer.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_buffer_resize(<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, DEMO_FILE_HANDLE *demo_fh, wt_off_t offset)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line">    <span class="keywordtype">size_t</span> off;</div><div class="line">    <span class="keywordtype">void</span> *p;</div><div class="line"></div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line">    off = (size_t)offset;</div><div class="line"></div><div class="line">    <span class="comment">/* Grow the buffer as necessary and clear any new space in the file. */</span></div><div class="line">    <span class="keywordflow">if</span> (demo_fh-&gt;bufsize &gt;= off)</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((p = realloc(demo_fh-&gt;buf, off)) == NULL) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session, <span class="stringliteral">&quot;%s: failed to resize buffer&quot;</span>, demo_fh-&gt;iface.name,</div><div class="line">          wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ENOMEM));</div><div class="line">        <span class="keywordflow">return</span> (ENOMEM);</div><div class="line">    }</div><div class="line">    memset((uint8_t *)p + demo_fh-&gt;bufsize, 0, off - demo_fh-&gt;bufsize);</div><div class="line">    demo_fh-&gt;buf = p;</div><div class="line">    demo_fh-&gt;bufsize = off;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_truncate --</span></div><div class="line"><span class="comment"> *     POSIX ftruncate.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_truncate(<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, wt_off_t offset)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line"></div><div class="line">    (void)file_handle; <span class="comment">/* Unused */</span></div><div class="line">    (void)session;     <span class="comment">/* Unused */</span></div><div class="line">    (void)offset;      <span class="comment">/* Unused */</span></div><div class="line"></div><div class="line">    demo_fh = (DEMO_FILE_HANDLE *)file_handle;</div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line"></div><div class="line">    (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session, <span class="stringliteral">&quot;%s: truncate not supported in storage source&quot;</span>,</div><div class="line">      demo_fh-&gt;iface.name, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ENOTSUP));</div><div class="line">    <span class="keywordflow">return</span> (ENOTSUP);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_file_write --</span></div><div class="line"><span class="comment"> *     POSIX pwrite.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_file_write(</div><div class="line">  <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *file_handle, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, wt_off_t offset, <span class="keywordtype">size_t</span> len, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line">    <span class="keywordtype">size_t</span> off;</div><div class="line">    <span class="keywordtype">int</span> ret = 0;</div><div class="line"></div><div class="line">    demo_fh = (DEMO_FILE_HANDLE *)file_handle;</div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line">    off = (size_t)offset;</div><div class="line"></div><div class="line">    lock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    ++demo_ss-&gt;write_ops;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_buffer_resize(</div><div class="line">           session, demo_fh, offset + (wt_off_t)(len + DEMO_FILE_SIZE_INCREMENT))) == 0) {</div><div class="line">        memcpy((uint8_t *)demo_fh-&gt;buf + off, buf, len);</div><div class="line">        <span class="keywordflow">if</span> (off + len &gt; demo_fh-&gt;size)</div><div class="line">            demo_fh-&gt;size = off + len;</div><div class="line">    }</div><div class="line">    unlock_storage_source(&amp;demo_ss-&gt;lock);</div><div class="line">    <span class="keywordflow">if</span> (ret == 0)</div><div class="line">        <span class="keywordflow">return</span> (0);</div><div class="line"></div><div class="line">    (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session,</div><div class="line">      <span class="stringliteral">&quot;%s: handle-write: failed to write %zu bytes at offset %zu: %s&quot;</span>, demo_fh-&gt;iface.name, len,</div><div class="line">      off, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, ret));</div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_handle_remove --</span></div><div class="line"><span class="comment"> *     Destroy an in-memory file handle. Should only happen on remove or shutdown.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_handle_remove(<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, DEMO_FILE_HANDLE *demo_fh)</div><div class="line">{</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html">WT_EXTENSION_API</a> *wtext;</div><div class="line"></div><div class="line">    demo_ss = demo_fh-&gt;demo_ss;</div><div class="line">    wtext = demo_ss-&gt;wtext;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (demo_fh-&gt;ref != 0) {</div><div class="line">        (void)wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a6d58298e356dbf58ac854c3d1af99678">err_printf</a>(wtext, session, <span class="stringliteral">&quot;demo_handle_remove: %s: file is currently open&quot;</span>,</div><div class="line">          demo_fh-&gt;iface.name, wtext-&gt;<a class="code" href="struct_w_t___e_x_t_e_n_s_i_o_n___a_p_i.html#a3fd4b5255e2f82139a846d66d67be565">strerror</a>(wtext, NULL, EBUSY));</div><div class="line">        <span class="keywordflow">return</span> (EBUSY);</div><div class="line">    }</div><div class="line"></div><div class="line">    TAILQ_REMOVE(&amp;demo_ss-&gt;fileq, demo_fh, q);</div><div class="line"></div><div class="line">    <span class="comment">/* Clean up private information. */</span></div><div class="line">    free(demo_fh-&gt;buf);</div><div class="line"></div><div class="line">    <span class="comment">/* Clean up public information. */</span></div><div class="line">    free(demo_fh-&gt;iface.name);</div><div class="line"></div><div class="line">    free(demo_fh);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * demo_handle_search --</span></div><div class="line"><span class="comment"> *     Return a matching handle, if one exists.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> DEMO_FILE_HANDLE *</div><div class="line">demo_handle_search(</div><div class="line">  WT_STORAGE_SOURCE *storage_source, WT_LOCATION_HANDLE *location_handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">    DEMO_FILE_HANDLE *demo_fh;</div><div class="line">    DEMO_STORAGE_SOURCE *demo_ss;</div><div class="line">    <span class="keywordtype">size_t</span> len;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *location;</div><div class="line"></div><div class="line">    demo_ss = (DEMO_STORAGE_SOURCE *)storage_source;</div><div class="line">    location = LOCATION_STRING(location_handle);</div><div class="line">    len = strlen(location);</div><div class="line"></div><div class="line">    TAILQ_FOREACH (demo_fh, &amp;demo_ss-&gt;fileq, q)</div><div class="line">        <span class="keywordflow">if</span> (strncmp(demo_fh-&gt;iface.name, location, len) == 0 &amp;&amp;</div><div class="line">          strcmp(&amp;demo_fh-&gt;iface.name[len], name) == 0)</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">return</span> (demo_fh);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *home;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_test_create(WT_STORAGE_SOURCE *ss, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, WT_LOCATION_HANDLE *location,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *objname, <span class="keyword">const</span> <span class="keywordtype">char</span> *content)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *fh;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *op;</div><div class="line">    <span class="keywordtype">size_t</span> len;</div><div class="line">    <span class="keywordtype">int</span> ret, t_ret;</div><div class="line"></div><div class="line">    fh = NULL;</div><div class="line">    len = strlen(content) + 1;</div><div class="line">    op = <span class="stringliteral">&quot;open&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_open_object(ss, session, location, objname, WT_SS_OPEN_CREATE, &amp;fh)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    op = <span class="stringliteral">&quot;write&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = fh-&gt;<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ab69c295b076627307a6528793d7a9b43">fh_write</a>(fh, session, 0, len, content)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">if</span> (fh != NULL &amp;&amp; (t_ret = fh-&gt;<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#aa4376c70336f8a0bbd8bf1c91749aeed">close</a>(fh, session)) != 0 &amp;&amp; ret == 0) {</div><div class="line">        op = <span class="stringliteral">&quot;close&quot;</span>;</div><div class="line">        ret = t_ret;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret != 0)</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;demo failed during %s: %s\n&quot;</span>, op, <a name="a32"></a><a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        printf(<span class="stringliteral">&quot;demo succeeded create %s\n&quot;</span>, objname);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_test_read(WT_STORAGE_SOURCE *ss, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, WT_LOCATION_HANDLE *location,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> *objname, <span class="keyword">const</span> <span class="keywordtype">char</span> *content)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html">WT_FILE_HANDLE</a> *fh;</div><div class="line">    <span class="keywordtype">char</span> buf[100];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *op;</div><div class="line">    <span class="keywordtype">size_t</span> len;</div><div class="line">    wt_off_t size;</div><div class="line">    <span class="keywordtype">int</span> ret, t_ret;</div><div class="line"></div><div class="line">    fh = NULL;</div><div class="line">    len = strlen(content) + 1;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the op string so that on error we know what failed. */</span></div><div class="line">    op = <span class="stringliteral">&quot;open&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_open_object(ss, session, location, objname, WT_SS_OPEN_READONLY, &amp;fh)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    op = <span class="stringliteral">&quot;size&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = fh-&gt;<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#a1e0b90f0a4fcf943e81b22b94069738b">fh_size</a>(fh, session, &amp;size)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    op = <span class="stringliteral">&quot;size-compare&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)size != len || (size_t)size &gt; <span class="keyword">sizeof</span>(buf)) {</div><div class="line">        ret = EINVAL;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    op = <span class="stringliteral">&quot;read&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = fh-&gt;<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#ad41718cb1f7a59cfb21a68785aa09897">fh_read</a>(fh, session, 0, len, buf)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    op = <span class="stringliteral">&quot;read-compare&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> (strncmp(buf, content, len) != 0) {</div><div class="line">        ret = EINVAL;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">if</span> (fh != NULL &amp;&amp; (t_ret = fh-&gt;<a class="code" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html#aa4376c70336f8a0bbd8bf1c91749aeed">close</a>(fh, session)) != 0 &amp;&amp; ret == 0) {</div><div class="line">        op = <span class="stringliteral">&quot;close&quot;</span>;</div><div class="line">        ret = t_ret;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret != 0)</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;demo failed during %s: %s\n&quot;</span>, op, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        printf(<span class="stringliteral">&quot;demo succeeded read %s\n&quot;</span>, objname);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_test_list(WT_STORAGE_SOURCE *ss, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session, <span class="keyword">const</span> <span class="keywordtype">char</span> *description,</div><div class="line">  WT_LOCATION_HANDLE *location, <span class="keyword">const</span> <span class="keywordtype">char</span> *prefix, uint32_t limit, uint32_t expect)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> **obj_list;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *op;</div><div class="line">    uint32_t i, obj_count;</div><div class="line">    <span class="keywordtype">int</span> ret, t_ret;</div><div class="line"></div><div class="line">    obj_list = NULL;</div><div class="line">    <span class="comment">/* Set the op string so that on error we know what failed. */</span></div><div class="line">    op = <span class="stringliteral">&quot;location_list&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_location_list(ss, session, location, prefix, limit, &amp;obj_list, &amp;obj_count)) !=</div><div class="line">      0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    op = <span class="stringliteral">&quot;location_list count&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> (obj_count != expect) {</div><div class="line">        ret = EINVAL;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    printf(<span class="stringliteral">&quot;list: %s:\n&quot;</span>, description);</div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; obj_count; i++) {</div><div class="line">        printf(<span class="stringliteral">&quot;  %s\n&quot;</span>, obj_list[i]);</div><div class="line">    }</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">if</span> (obj_list != NULL &amp;&amp;</div><div class="line">      (t_ret = ss-&gt;ss_location_list_free(ss, session, obj_list, obj_count)) != 0 &amp;&amp; ret == 0) {</div><div class="line">        op = <span class="stringliteral">&quot;location_list_free&quot;</span>;</div><div class="line">        ret = t_ret;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret != 0)</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;demo failed during %s: %s\n&quot;</span>, op, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        printf(<span class="stringliteral">&quot;demo succeeded location_list %s\n&quot;</span>, description);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line">demo_test_storage_source(WT_STORAGE_SOURCE *ss, <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session)</div><div class="line">{</div><div class="line">    WT_LOCATION_HANDLE *location1, *location2;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *op;</div><div class="line">    <span class="keywordtype">int</span> ret, t_ret;</div><div class="line">    <span class="keywordtype">bool</span> exist;</div><div class="line"></div><div class="line">    location1 = location2 = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/* Create two locations. Set the op string so that on error we know what failed. */</span></div><div class="line">    op = <span class="stringliteral">&quot;location_handle&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_location_handle(ss, session, <span class="stringliteral">&quot;location-one&quot;</span>, &amp;location1)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_location_handle(ss, session, <span class="stringliteral">&quot;location-two&quot;</span>, &amp;location2)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Create and existence checks. In location-one, create &quot;A&quot;. In location-two, create &quot;A&quot;, &quot;B&quot;,</span></div><div class="line"><span class="comment">     * &quot;AA&quot;. We&#39;ll do simple lists of both locations, and a list of location-two with a prefix.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    op = <span class="stringliteral">&quot;create/exist checks&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_create(ss, session, location1, <span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;location-one-A&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_exist(ss, session, location1, <span class="stringliteral">&quot;A&quot;</span>, &amp;exist)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> (!exist) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Exist test failed for A\n&quot;</span>);</div><div class="line">        ret = EINVAL;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> ((ret = ss-&gt;ss_exist(ss, session, location2, <span class="stringliteral">&quot;A&quot;</span>, &amp;exist)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> (exist) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Exist test failed for A in location2\n&quot;</span>);</div><div class="line">        ret = EINVAL;</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_create(ss, session, location2, <span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;location-two-A&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_create(ss, session, location2, <span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;location-two-B&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_create(ss, session, location2, <span class="stringliteral">&quot;AA&quot;</span>, <span class="stringliteral">&quot;location-two-AA&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/* Make sure the objects contain the expected data. */</span></div><div class="line">    op = <span class="stringliteral">&quot;read checks&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_read(ss, session, location1, <span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;location-one-A&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_read(ss, session, location2, <span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;location-two-A&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_read(ss, session, location2, <span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;location-two-B&quot;</span>)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * List the locations. For location-one, we expect just one object.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    op = <span class="stringliteral">&quot;list checks&quot;</span>;</div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_list(ss, session, <span class="stringliteral">&quot;location1&quot;</span>, location1, NULL, 0, 1)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * For location-two, we expect three objects.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_list(ss, session, <span class="stringliteral">&quot;location2&quot;</span>, location2, NULL, 0, 3)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * If we limit the number of objects received to 2, we should only see 2.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_list(ss, session, <span class="stringliteral">&quot;location2, limit:2&quot;</span>, location2, NULL, 2, 2)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * With a prefix of &quot;A&quot;, and no limit, we&#39;ll see two objects.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_list(ss, session, <span class="stringliteral">&quot;location2: A&quot;</span>, location2, <span class="stringliteral">&quot;A&quot;</span>, 0, 2)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * With a prefix of &quot;A&quot;, and a limit of one, we&#39;ll see just one object.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_list(ss, session, <span class="stringliteral">&quot;location2: A, limit:1&quot;</span>, location2, <span class="stringliteral">&quot;A&quot;</span>, 1, 1)) != 0)</div><div class="line">        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">err:</div><div class="line">    <span class="keywordflow">if</span> (location1 != NULL &amp;&amp; (t_ret = location1-&gt;close(location1, session)) != 0 &amp;&amp; ret == 0)</div><div class="line">        ret = t_ret;</div><div class="line">    <span class="keywordflow">if</span> (location2 != NULL &amp;&amp; (t_ret = location2-&gt;close(location2, session)) != 0 &amp;&amp; ret == 0)</div><div class="line">        ret = t_ret;</div><div class="line">    <span class="keywordflow">if</span> (ret != 0)</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;demo failed during %s: %s\n&quot;</span>, op, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">main(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html">WT_CONNECTION</a> *conn;</div><div class="line">    <a class="code" href="struct_w_t___s_e_s_s_i_o_n.html">WT_SESSION</a> *session;</div><div class="line">    WT_STORAGE_SOURCE *storage_source;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *open_config;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line"></div><div class="line">    fprintf(stderr, <span class="stringliteral">&quot;ex_storage_source: starting\n&quot;</span>);</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Create a clean test directory for this run of the test program if the environment variable</span></div><div class="line"><span class="comment">     * isn&#39;t already set (as is done by make check).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;WIREDTIGER_HOME&quot;</span>) == NULL) {</div><div class="line">        home = <span class="stringliteral">&quot;WT_HOME&quot;</span>;</div><div class="line">        <span class="keywordflow">if</span> ((ret = system(<span class="stringliteral">&quot;rm -rf WT_HOME &amp;&amp; mkdir WT_HOME&quot;</span>)) != 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;system: directory recreate failed: %s\n&quot;</span>, strerror(ret));</div><div class="line">            <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span></div><div class="line">        home = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Setup a configuration string that will load our custom storage source. Use the special local</span></div><div class="line"><span class="comment">     * extension to indicate that the entry point is in the same executable. Finally, pass in two</span></div><div class="line"><span class="comment">     * pieces of configuration information to our initialization function as the &quot;config&quot; value.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    open_config =</div><div class="line">      <span class="stringliteral">&quot;create,log=(enabled=true),extensions=(local={entry=demo_storage_source_create,&quot;</span></div><div class="line">      <span class="stringliteral">&quot;config={config_string=\&quot;demo-storage-source\&quot;,config_value=37}})&quot;</span>;</div><div class="line">    <span class="comment">/* Open a connection to the database, creating it if necessary. */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = <a name="a33"></a><a class="code" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813">wiredtiger_open</a>(home, NULL, open_config, &amp;conn)) != 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error connecting to %s: %s\n&quot;</span>, home == NULL ? <span class="stringliteral">&quot;.&quot;</span> : home,</div><div class="line">          <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> ((ret = conn-&gt;<a name="a34"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#adad5965cd4a60f65b5ac01f7ca6d1fc0">open_session</a>(conn, NULL, NULL, &amp;session)) != 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WT_CONNECTION.open_session: %s\n&quot;</span>, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((ret = conn-&gt;get_storage_source(conn, <span class="stringliteral">&quot;demo&quot;</span>, &amp;storage_source)) != 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;WT_CONNECTION.get_storage_source: %s\n&quot;</span>, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">    }</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * At the moment, the infrastructure within WiredTiger that would use the storage source</span></div><div class="line"><span class="comment">     * extension does not exist. So call the interface directly as a demonstration.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> ((ret = demo_test_storage_source(storage_source, session)) != 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;storage source test failed: %s\n&quot;</span>, <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> ((ret = conn-&gt;<a name="a35"></a><a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#af535c517df851eeac8ebf3594d40b545">close</a>(conn, NULL)) != 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error closing connection to %s: %s\n&quot;</span>, home == NULL ? <span class="stringliteral">&quot;.&quot;</span> : home,</div><div class="line">          <a class="code" href="group__wt.html#gae8bf720ddb4a7a7390b70424594c40fd">wiredtiger_strerror</a>(ret));</div><div class="line">        <span class="keywordflow">return</span> (EXIT_FAILURE);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (EXIT_SUCCESS);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
