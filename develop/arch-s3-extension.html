<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: S3 Storage Source</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('arch-s3-extension.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">S3 Storage Source </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="arch_head"><table class="doxtable">
<tr>
<th rowspan="2" style="width:10%;"> <div><a href="arch-index.html"><img class="arch_thumbnail" src="wt_diagram.png" usemap="#wt_diagram_map" style="background-image: url(wt_diagram.png)"></a></div></th><th style="width:44%">Data Structures</th><th style="width:45%">Source Location</th></tr>
<map id="wt_diagram_map" name="wt_diagram_map">
<area shape="rect" id="id1" href="modules.html" title="modules.html" alt="" coords="248,128,283,144"/>
<area shape="rect" id="id2" href="arch-cache.html" title="arch-cache.html" alt="" coords="204,546,248,562"/>
<area shape="rect" id="id3" href="arch-cursor.html" title="arch-cursor.html" alt="" coords="234,224,280,240"/>
<area shape="rect" id="id4" href="arch-eviction.html" title="arch-eviction.html" alt="" coords="303,546,356,562"/>
<area shape="rect" id="id5" href="arch-logging.html" title="arch-logging.html" alt="" coords="388,650,443,666"/>
<area shape="rect" id="id6" href="arch-schema.html" title="arch-schema.html" alt="" coords="123,224,179,240"/>
<area shape="rect" id="id7" href="command_line.html" title="command_line.html" alt="" coords="374,23,430,39"/>
<area shape="rect" id="id8" href="arch-log-file.html" title="arch-log-file.html" alt="" coords="308,865,339,897"/>
<area shape="rect" id="id9" href="arch-metadata.html" title="arch-metadata.html" alt="" coords="25,328,89,344"/>
<area shape="rect" id="id10" href="arch-python.html" title="arch-python.html" alt="" coords="84,23,157,39"/>
<area shape="rect" id="id11" href="arch-snapshot.html" title="arch-snapshot.html" alt="" coords="297,441,371,457"/>
<area shape="rect" id="id12" href="arch-transaction.html" title="arch-transaction.html" alt="" coords="298,328,387,344"/>
<area shape="rect" id="id13" href="arch-hs.html" title="arch-hs.html" alt="" coords="93,642,140,674"/>
<area shape="rect" id="id14" href="arch-block.html" title="arch-block.html" alt="" coords="196,642,256,674"/>
<area shape="rect" id="id15" href="arch-dhandle.html" title="arch-dhandle.html" alt="" coords="144,320,205,352"/>
<area shape="rect" id="id16" href="arch-data-file.html" title="arch-data-file.html" alt="" coords="179,865,245,897"/>
<area shape="rect" id="id17" href="arch-row-column.html" title="arch-row-column.html" alt="" coords="117,433,205,465"/>
<area shape="rect" id="id18" href="arch-fs-os.html" title="arch-fs-os.html" alt="" coords="175,755,357,771"/>
</map>
<tr>
<td><code><code>S3_FILE_HANDLE<br  />
S3_FILE_SYSTEM<br  />
S3_STORAGE</code></code></td><td><code><code>ext/storage_sources/s3_store/</code></code></td></tr>
</table>
</div><p> <b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<h1><a class="anchor" id="s3_extension_storage_source"></a>
S3 Storage Source Implementation</h1>
<p>S3 storage source, or the S3 store, is a WiredTiger extension that implements the storage source abstraction for AWS's S3 object-store. The store extends the WiredTiger's capability to store the data files on the S3 cloud. The extension provides a means to construct, configure and control a custom file system linked to an S3 bucket. The extension internally uses the API provided by the AWS C++ SDK to interact with the S3 cloud.</p>
<p>The S3 store implements the following key functionalities defined by the storage source interface:</p>
<ul>
<li>Initialize the store, the AWS SDK and create a logging module for the store and the SDK.</li>
<li>Register the S3 store as a storage source available to Wiredtiger.</li>
<li>Provide an API to access and terminate the store. A reference count is incremented each time the storage source reference is taken and decremented with the termination. When the reference count goes zero, the storage source is de-registered with WiredTiger and any allocated resources are freed.</li>
<li>Another essential functionality the S3 store provides is to create a <code><a class="el" href="struct_w_t___f_i_l_e___s_y_s_t_e_m.html" title="The interface implemented by applications to provide a custom file system implementation.">WT_FILE_SYSTEM</a></code> implementation for a given bucket. The store requires a bucket and an access token to create the filesystem. The bucket is expected to be a string argument, which is the bucket name and the corresponding region separated by a ';', e.g. "bucket1;ap-southeast-2". AWS requires an access token to authenticate programmatic access to S3. The access token comprises of an access key ID and a secret access key as a set. The S3 store requires the token to be provided as a single string argument of the access key followed by the secret key, separated by a ';'.</li>
<li>The S3 store also configures a directory on the file system local to the WiredTiger database as a cache for the object files. The cache is used to improve the read latency for the object files read after an initial download from the S3.</li>
</ul>
<h1><a class="anchor" id="s3_extension_connection"></a>
S3 Connection class</h1>
<p>The S3Connection class represents an active connection to an S3 bucket. It encapsulates and implements all the operations the S3 filesystem requires. The instantiation of the class object authenticates with the AWS and validates the existence of and access to the configured bucket. The S3Connection exposes an API to list the bucket contents filtered by a directory and a prefix, check for an object's existence in the bucket, put an object to the cloud, and get the object from the cloud. Though not required for the file system's implementation, the class also provides the means to delete the objects to clean up artifacts from the internal unit testing.</p>
<h1><a class="anchor" id="s3_extension_file_system"></a>
S3_FILE_SYSTEM</h1>
<p>WiredTiger supports a database over a custom file system by giving a <code><a class="el" href="struct_w_t___f_i_l_e___s_y_s_t_e_m.html" title="The interface implemented by applications to provide a custom file system implementation.">WT_FILE_SYSTEM</a></code> interface for the end-user to implement. The S3 store itself provides a means to configure as many file systems as needed, each linked to an S3 bucket. These file systems, called the <code>S3_FILE_SYSTEM</code>, are a custom implementation provided by the S3 store. The S3 filesystem contains an instance of the S3Connection class, hence providing an active connection to the S3 bucket embedded in the file system instance.</p>
<p>The S3 file system uses the functionality provided by the S3 connection to simulate a write-once-read-many file system. The filesystem can list the directory contents, check for a file's presence, and access the file by creating a filehandle. The files that are not in the cache are first downloaded from the bucket and put in the cache before a filehandle is made to access them.</p>
<p>The S3 store uses the filesystem's put-object functionality to flush the files into the cloud. The Tier Manager inside WiredTiger directs the flush of the files. The files pushed to the cloud are also copied to the local cache for easy access.</p>
<h1><a class="anchor" id="s3_extension_file_handle"></a>
S3_FILE_HANDLE</h1>
<p>The S3 store also implements the <code><a class="el" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html" title="A file handle implementation returned by WT_FILE_SYSTEM::open_file.">WT_FILE_HANDLE</a></code> interface, <code>S3_FILE_HANDLE</code>, to access the files on the S3 file system. When the handle is created, the local cache gets a copy of the S3 object if it doesn't already have it. That copy will be accessed by the handle. Since the local cache is a directory on the WiredTiger database's file system, the file is accessed using a <code><a class="el" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html" title="A file handle implementation returned by WT_FILE_SYSTEM::open_file.">WT_FILE_HANDLE</a></code> implementation native to WiredTiger. Hence, a copy of native <code><a class="el" href="struct_w_t___f_i_l_e___h_a_n_d_l_e.html" title="A file handle implementation returned by WT_FILE_SYSTEM::open_file.">WT_FILE_HANDLE</a></code> is kept encapsulated in the S3 filehandle. Since the object store is archival, all the write access methods are disabled.</p>
<h1><a class="anchor" id="s3_extension_log_stat"></a>
S3 Logging and Statistics</h1>
<p>The S3 store provides a logger implementation that redirects the generated logs to the WiredTiger logging streams. AWS SDK also registers the same logger, and the best attempt is made to match the SDK's logging levels to WiredTiger's.</p>
<p>Several statistics are also collected to count various interactions with S3 and the operations on the objects and files. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-mem-disk.html">Moving Data Between Memory and Disk</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
