<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Join cursors</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('cursor_join.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Join cursors </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Join cursors provide a way to iterate over a subset of a table, where the subset is specified by relationships with reference cursors.</p>
<p>A join cursor is created with <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d" title="Open a new cursor on a data source or duplicate an existing cursor.">WT_SESSION::open_cursor</a> using a <code>"join:table:&lt;name&gt;"</code> URI prefix. Then reference cursors are positioned to keys on indices and joined to the join cursor using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84" title="Join a join cursor with a reference cursor.">WT_SESSION::join</a> calls. The result is a join cursor that can be iterated to satisfy the join equation.</p>
<p>Here is an example using join cursors:</p>
<div class="fragment"><div class="line">    <span class="comment">/* Open cursors needed by the join. */</span></div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;join:table:poptable&quot;</span>, NULL, NULL, &amp;join_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:poptable:country&quot;</span>, NULL, NULL, &amp;country_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:poptable:immutable_year&quot;</span>, NULL, NULL, &amp;year_cursor));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* select values WHERE country == &quot;AU&quot; AND year &gt; 1900 */</span></div>
<div class="line">    country_cursor-&gt;set_key(country_cursor, <span class="stringliteral">&quot;AU\0\0\0&quot;</span>);</div>
<div class="line">    error_check(country_cursor-&gt;search(country_cursor));</div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, country_cursor, <span class="stringliteral">&quot;compare=eq,count=10&quot;</span>));</div>
<div class="line">    year_cursor-&gt;set_key(year_cursor, (uint16_t)1900);</div>
<div class="line">    error_check(year_cursor-&gt;search(year_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, year_cursor, <span class="stringliteral">&quot;compare=gt,count=10,strategy=bloom&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* List the values that are joined */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((ret = join_cursor-&gt;next(join_cursor)) == 0) {</div>
<div class="line">        error_check(join_cursor-&gt;get_key(join_cursor, &amp;recno));</div>
<div class="line">        error_check(join_cursor-&gt;get_value(join_cursor, &amp;country, &amp;year, &amp;population));</div>
<div class="line">        printf(<span class="stringliteral">&quot;ID %&quot;</span> PRIu64, recno);</div>
<div class="line">        printf(</div>
<div class="line">          <span class="stringliteral">&quot;: country %s, year %&quot;</span> PRIu16 <span class="stringliteral">&quot;, population %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, country, year, population);</div>
<div class="line">    }</div>
<div class="line">    scan_end_check(ret == <a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>);</div>
</div><!-- fragment --><p> Joins support various comparison operators: <code>"eq"</code>, <code>"gt"</code>, <code>"ge"</code>, <code>"lt"</code>, <code>"le"</code>. Ranges with lower and upper bounds can also be specified, by joining two cursors on the same index, for example, one with <code>"compare=ge"</code> and another <code>"compare=lt"</code>. In addition to joining indices, the main table can be joined so that a range of primary keys can be specified.</p>
<p>By default, a join cursor returns a conjunction, that is, all keys that satisfy all the joined comparisons. By specifying a configuration with <code>"operation=or"</code>, a join cursor will return a disjunction, or all keys that satisfy at least one of the joined comparisons. More complex joins can be composed by specifying another join cursor as the reference cursor in a join call.</p>
<p>Here is an example using these concepts to show a conjunction of a disjunction:</p>
<div class="fragment"><div class="line">    <span class="comment">/* Open cursors needed by the join. */</span></div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;join:table:poptable&quot;</span>, NULL, NULL, &amp;join_cursor));</div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;join:table:poptable&quot;</span>, NULL, NULL, &amp;subjoin_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:poptable:country&quot;</span>, NULL, NULL, &amp;country_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:poptable:country&quot;</span>, NULL, NULL, &amp;country_cursor2));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:poptable:immutable_year&quot;</span>, NULL, NULL, &amp;year_cursor));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * select values WHERE (country == &quot;AU&quot; OR country == &quot;UK&quot;)</span></div>
<div class="line"><span class="comment">     *                     AND year &gt; 1900</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * First, set up the join representing the country clause.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    country_cursor-&gt;set_key(country_cursor, <span class="stringliteral">&quot;AU\0\0\0&quot;</span>);</div>
<div class="line">    error_check(country_cursor-&gt;search(country_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, subjoin_cursor, country_cursor, <span class="stringliteral">&quot;operation=or,compare=eq,count=10&quot;</span>));</div>
<div class="line">    country_cursor2-&gt;set_key(country_cursor2, <span class="stringliteral">&quot;UK\0\0\0&quot;</span>);</div>
<div class="line">    error_check(country_cursor2-&gt;search(country_cursor2));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, subjoin_cursor, country_cursor2, <span class="stringliteral">&quot;operation=or,compare=eq,count=10&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Join that to the top join, and add the year clause */</span></div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, subjoin_cursor, NULL));</div>
<div class="line">    year_cursor-&gt;set_key(year_cursor, (uint16_t)1900);</div>
<div class="line">    error_check(year_cursor-&gt;search(year_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, year_cursor, <span class="stringliteral">&quot;compare=gt,count=10,strategy=bloom&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* List the values that are joined */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((ret = join_cursor-&gt;next(join_cursor)) == 0) {</div>
<div class="line">        error_check(join_cursor-&gt;get_key(join_cursor, &amp;recno));</div>
<div class="line">        error_check(join_cursor-&gt;get_value(join_cursor, &amp;country, &amp;year, &amp;population));</div>
<div class="line">        printf(<span class="stringliteral">&quot;ID %&quot;</span> PRIu64, recno);</div>
<div class="line">        printf(</div>
<div class="line">          <span class="stringliteral">&quot;: country %s, year %&quot;</span> PRIu16 <span class="stringliteral">&quot;, population %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, country, year, population);</div>
<div class="line">    }</div>
<div class="line">    scan_end_check(ret == <a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>);</div>
</div><!-- fragment --><p> All the joins should be done on the join cursor before <a class="el" href="struct_w_t___c_u_r_s_o_r.html#a0503f16bd8f3d05aa3552f229b3a8e1b" title="Return the next record.">WT_CURSOR::next</a> is called. Calling <a class="el" href="struct_w_t___c_u_r_s_o_r.html#a0503f16bd8f3d05aa3552f229b3a8e1b" title="Return the next record.">WT_CURSOR::next</a> on a join cursor for the first time populates any bloom filters and performs other initialization. The join cursor's key is the primary key (the key for the main table), and its value is the entire set of values of the main table. A join cursor can be created with a projection by appending <code>"(col1,col2,...)"</code> to the URI if a different set of values is needed.</p>
<p>Keys returned from the join cursor are ordered according to the first reference cursor joined. For example, if an index cursor was joined first, that index determines the order of results. If the join cursor uses disjunctions, then the ordering of all joins determines the order. The first join in a conjunctive join, or all joins in a disjunctive join, are distinctive in that they are iterated internally as the cursor join returns values in order. Any bloom filters specified on the joins that are used for iteration are not useful, and are silently ignored.</p>
<p>When disjunctions are used where the sets of keys overlap on these 'iteration joins', a join cursor will return duplicates. A join cursor never returns duplicates unless <code>"operation=or"</code> is used in a join configuration, or unless the first joined cursor is itself a join cursor that would return duplicates.</p>
<p>Another example of using a join cursor is provided in <a class="el" href="ex_col_store_8c-example.html">ex_col_store.c</a>. Here the columns hour and temp are joined together to find the maximum and minimum temperature for a given time period.</p>
<div class="fragment"><div class="line"> </div>
<div class="line">    <span class="comment">/* Open cursors needed by the join. */</span></div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;join:table:weather(hour,temp)&quot;</span>, NULL, NULL, &amp;join_cursor));</div>
<div class="line">    error_check(</div>
<div class="line">      session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:weather:hour&quot;</span>, NULL, NULL, &amp;start_time_cursor));</div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">open_cursor</a>(session, <span class="stringliteral">&quot;index:weather:hour&quot;</span>, NULL, NULL, &amp;end_time_cursor));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Select values WHERE (hour &gt;= start AND hour &lt;= end). Find the starting record closest to</span></div>
<div class="line"><span class="comment">     * desired start time.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    start_time_cursor-&gt;set_key(start_time_cursor, start_time);</div>
<div class="line">    error_check(start_time_cursor-&gt;search_near(start_time_cursor, &amp;exact));</div>
<div class="line">    <span class="keywordflow">if</span> (exact == -1) {</div>
<div class="line">        ret = start_time_cursor-&gt;next(start_time_cursor);</div>
<div class="line">        <span class="keywordflow">if</span> (ret == <a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>)</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            error_check(ret);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, start_time_cursor, <span class="stringliteral">&quot;compare=ge&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Find the ending record closest to desired end time. */</span></div>
<div class="line">    end_time_cursor-&gt;set_key(end_time_cursor, end_time);</div>
<div class="line">    error_check(end_time_cursor-&gt;search_near(end_time_cursor, &amp;exact));</div>
<div class="line">    <span class="keywordflow">if</span> (exact == 1) {</div>
<div class="line">        ret = end_time_cursor-&gt;prev(end_time_cursor);</div>
<div class="line">        <span class="keywordflow">if</span> (ret == <a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>)</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            error_check(ret);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">join</a>(session, join_cursor, end_time_cursor, <span class="stringliteral">&quot;compare=le&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initialize minimum temperature and maximum temperature to temperature of the first record. */</span></div>
<div class="line">    ret = join_cursor-&gt;next(join_cursor);</div>
<div class="line">    <span class="keywordflow">if</span> (ret == <a class="code" href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a>)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        error_check(ret);</div>
<div class="line"> </div>
<div class="line">    error_check(join_cursor-&gt;get_key(join_cursor, &amp;recno));</div>
<div class="line">    error_check(join_cursor-&gt;get_value(join_cursor, &amp;hour, &amp;temp));</div>
<div class="line">    *min_temp = temp;</div>
<div class="line">    *max_temp = temp;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Iterating through found records between start and end time to find the min &amp; max temps. */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((ret = join_cursor-&gt;next(join_cursor)) == 0) {</div>
<div class="line">        error_check(join_cursor-&gt;get_value(join_cursor, &amp;hour, &amp;temp));</div>
<div class="line"> </div>
<div class="line">        *min_temp = WT_MIN(*min_temp, temp);</div>
<div class="line">        *max_temp = WT_MAX(*max_temp, temp);</div>
<div class="line">    }</div>
<div class="line"> </div>
</div><!-- fragment --></div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="astruct_w_t___s_e_s_s_i_o_n_html_afb5b4a69c2c5cafe411b2b04fdc1c75d"><div class="ttname"><a href="struct_w_t___s_e_s_s_i_o_n.html#afb5b4a69c2c5cafe411b2b04fdc1c75d">WT_SESSION::open_cursor</a></div><div class="ttdeci">int open_cursor(WT_SESSION *session, const char *uri, WT_CURSOR *to_dup, const char *config, WT_CURSOR **cursorp)</div><div class="ttdoc">Open a new cursor on a data source or duplicate an existing cursor.</div></div>
<div class="ttc" id="astruct_w_t___s_e_s_s_i_o_n_html_ae0ab118df83d173c6a20eb1ea3f3fd84"><div class="ttname"><a href="struct_w_t___s_e_s_s_i_o_n.html#ae0ab118df83d173c6a20eb1ea3f3fd84">WT_SESSION::join</a></div><div class="ttdeci">int join(WT_SESSION *session, WT_CURSOR *join_cursor, WT_CURSOR *ref_cursor, const char *config)</div><div class="ttdoc">Join a join cursor with a reference cursor.</div></div>
<div class="ttc" id="agroup__wt_html_ga3c9e1b494d95cf34404ab7a974af6bf8"><div class="ttname"><a href="group__wt.html#ga3c9e1b494d95cf34404ab7a974af6bf8">WT_NOTFOUND</a></div><div class="ttdeci">#define WT_NOTFOUND</div><div class="ttdoc">Item not found.</div><div class="ttdef"><b>Definition:</b> wiredtiger.in:3826</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
