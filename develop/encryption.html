<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Encryptors</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.3.0</span>
   </div>
   <div id="projectbrief"><!-- 11.3.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('encryption.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Encryptors </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="encryption_overview"></a>
Overview of Encryption in WiredTiger</h1>
<p>This section explains how to configure and work with encryption in WiredTiger.</p>
<p>WiredTiger now provides built-in support for encryption with an extension using the open-source <a href="https://libsodium.org">libsodium</a> cryptography library. Application developers may also write their own <a class="el" href="encryption.html#encryption_custom">custom encryption extensions</a>. Three example extensions are provided for expository and testing purposes.</p>
<dl class="section warning"><dt>Warning</dt><dd>The encryption infrastructure included in WiredTiger, when used with an extension providing a strong encryption algorithm, is intended only to protect data stored in files (that is, it provides <em>encryption at rest</em>). The table content (keys, values), the metadata pertaining to data (table, index, column names, and other configuration information) as well as the database log files are encrypted on disk. However, it does not protect data in memory while the database is running. Decryption occurs when the data is read into memory; thus an attacker having the ability to directly read system memory will have access to unencrypted data. Many systems may also page memory to a backing disk under load. The security of any such <em>paging</em> or <em>swap</em> devices must be considered when planning the security of a system; in general, they should be disabled or themselves encrypted using operating system or storage system facilities.</dd></dl>
<h1><a class="anchor" id="encryption_use"></a>
Using an encryption extension</h1>
<p>Enabling encryption involves two steps: first, loading the encryptor extension, and second, enabling and configuring it. Extensions must be loaded in the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> call. See <a class="el" href="extensions.html">Extending WiredTiger</a> for details about how extensions are loaded.</p>
<p>Encryption must be enabled first for the overall database (the <em>system</em> encryption) by passing the encryption configuration (described shortly) to the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> call. This establishes the encryption algorithm and keys to be used for database log files and a subset of the WiredTiger metadata files. By default, this same encryption is also used for all data files.</p>
<p>Encryption may also be enabled separately for individual tables, column groups, and indices, by passing a different encryption configuration to the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a> call. This configuration overrides the system encryption for the data file so created. It may use a different encryptor and/or different key (except as noted below). It is also possible to disable encryption for individual tables; this is of course usually undesirable, but possibly a reasonable option for high-churn low-value data.</p>
<p>Each table, column group, and index that is to have encryption different from the system encryption must be configured explicitly; encryption configuration is not inherited by column groups or indices from the table they apply to. Such encryption must be specified when the data file is created; otherwise the system encryption is used.</p>
<p>It is an error to specify encryption in a <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a> call when it was not specified in the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> call. This prevents accidental exposure of the file's data in log files, which would be written in the clear in such a scenario.</p>
<dl class="section warning"><dt>Warning</dt><dd>When using separate keys for individual data files or tables, the key used for the system encryption continues to have fundamental importance. The database log, protected by the system encryption, contains a shared stream of changes to all data files. Thus, if the system key is exposed, even when per-file keys are not exposed, an attacker can read database log files, and hence has access to data in individual files.</dd></dl>
<p>Note that because every encryptor providing strong encryption should also include a cryptographically strong checksum, WiredTiger's own block checksums can safely be disabled. See <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a>.</p>
<h1><a class="anchor" id="encryption_config"></a>
Encryption configuration</h1>
<p>Encryption is configured using the <code>encryption=</code> configuration parameter. As noted above this must be passed to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> and may also be passed to <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a>. The value of <code>encryption=</code> is a nested configuration string with up to three parameters. The first should be <code>name=</code> to select the encryption extension to use. This is the name of the encryptor and should be the string the encryptor's initialization method passed to <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a59d203f4474780ca34bd3e07b8064949" title="Add an encryption function.">WT_CONNECTION::add_encryptor</a>. For the built-in libsodium extension, this name is "sodium". The other parameters, <code>keyid</code> and <code>secretkey</code>, are used to specify the encryption key. To disable encryption for an individual table the reserved value <code>name=none</code> may be passed when creating it. (As is noted above, this is usually not desirable.)</p>
<h1><a class="anchor" id="encryption_keyid"></a>
Keys via key ID</h1>
<p>The configuration parameter <code>encryption=(keyid=<em>identifier</em>)</code> may be used in <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> or <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a> calls. This is intended to reference a key stored using a Key Management Solution (KMS). The <code>keyid</code> given to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> is stored in the clear in WiredTiger configuration files; it should never contain sensitive information. Consequently, however, it need only be specified when the database is created; it is remembered thereafter. Additional <code>keyid</code> values may be used freely for different database files. These are stored in WiredTiger metadata using the system encryption.</p>
<p>As an example, with a <code>keyid</code> of <code>"customerABC"</code>, the encryptor would consult the KMS to return a key previously stored for <code>"customerABC"</code>. The encryptor would then use the returned key when encrypting.</p>
<h1><a class="anchor" id="encryption_secretkey"></a>
Keys via explicit secret key</h1>
<p>The configuration parameter <code>encryption=(secretkey=<em>key</em>)</code> is used only in the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> call. The value of the secret key is never stored on disk in any form, so it must always be provided when WiredTiger is reopened (again, with the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> call). It may <em>not</em> be passed to <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a>; consequently if no KMS is available different keys cannot be used for individual tables.</p>
<p>If a <code>secretkey</code> is used, it must be provided using the <code>-E</code> command-line option when using the <code>wt</code> utility. Specifying <code>keyid</code> is not needed with the <code>wt</code> utility, as the <code>keyid</code> is stored in the clear on disk by WiredTiger. Note that while the <code>wt</code> utility takes some steps to prevent it, on most systems it is possible to see command-line arguments using operating system facilities. This creates some risk of exposure that must be considered. Using a KMS is probably preferable where possible. Alternatively, one might avoid using the <code>wt</code> utility entirely when using encryption, as it is not necessary.</p>
<p>Both <code>keyid</code> and <code>secretkey</code> values are not interpreted by the configuration framework; their exact interpretation and the sets of possible values are determined by the encryptor in use.</p>
<h1><a class="anchor" id="encryption_custom"></a>
Custom encryption extensions</h1>
<p>Applications may provide their own encryption extensions. Custom encryptors must be coded in the C language. Once packaged, they can be used in any language. For further information, see: <a class="el" href="extensions.html">general information on extending WiredTiger</a>, and the encryptor interface <a class="el" href="struct_w_t___e_n_c_r_y_p_t_o_r.html" title="The interface implemented by applications to provide custom encryption.">WT_ENCRYPTOR</a>.</p>
<p>A simple example <a class="el" href="ex_encrypt_8c-example.html">application with its own encryptor</a> is provided to demonstrate how this may be done. It shows both how to install a custom extension and then how to configure it. (Note, however, that it uses a trivial "encryption" that provides no security.)</p>
<p>Three additional encryptor extensions are included with WiredTiger. These are built as shared libraries to show how that can be done.</p>
<h1><a class="anchor" id="encryption_sodium"></a>
The libsodium encryption extension</h1>
<p>The "sodium" encryptor uses the open source <a href="https://libsodium.org">libsodium</a> cryptography library. It currently has no support for key management and thus does not support <code>keyid</code> configurations, only <code>secretkey</code>. The <code>secretkey</code> is expected to be a 256-bit XChaCha20 key encoded in hex (with no leading <code>0x</code>). This is not directly suitable for applications that wish to use manually-entered passwords or passphrases. Applications for which these restrictions are unsuitable can copy the <a class="el" href="sodium_encrypt_8c-example.html">extension code</a> and extend it as needed, using additional material from libsodium or other libraries.</p>
<p>The sodium encryptor is intended to protect against disclosure of data, such as might otherwise happen with a database on a stolen laptop. It may provide some protection against malicious corruption of a database by an adversary with write access to the database files, but is not intended for this purpose and should not be relied upon in this context. (Note that on most operating systems, and in most situations, an adversary with write access to the database files is highly likely to also be able to read data out of memory while the database is running, and change it as well, so this limitation is not necessarily important.)</p>
<p>To use the encryptor, first install libsodium; then you can compile WiredTiger with the extension by passing the argument <code>-DENABLE_SODIUM=1</code> to cmake.</p>
<p>If libsodium is installed in a location not normally searched by the compiler toolchain, you'll need to modify the include and library paths to indicate these locations. For example, with the libsodium includes and libraries installed in <code>/usr/local/include</code> and <code>/usr/local/lib</code>, you would run cmake with the following additional arguments:</p>
<div class="fragment"><div class="line">-DENABLE_SODIUM=1 -DCMAKE_INCLUDE_PATH=/usr/local/include -DCMAKE_LIBRARY_PATH=/usr/local/lib</div>
</div><!-- fragment --><p>When opening the WiredTiger database, load the libsodium plugin library as an extension. For example, with the WiredTiger library installed in <code>/usr/local/lib</code>, you would use the following code:</p>
<div class="fragment"><div class="line">    <span class="keywordtype">char</span> conf[1024];</div>
<div class="line">    snprintf(conf, <span class="keyword">sizeof</span>(conf),</div>
<div class="line">      <span class="stringliteral">&quot;create,extensions=[/usr/local/lib/libwiredtiger_sodium.so],&quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;encryption=(name=sodium,secretkey=%s)&quot;</span>,</div>
<div class="line">      secretkey);</div>
<div class="line">    error_check(<a class="code" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813">wiredtiger_open</a>(home, NULL, conf, &amp;conn));</div>
</div><!-- fragment --><p> where <code>secretkey</code> comes from some suitable place. (Never compile in cryptographic keys.)</p>
<p>Because this encryptor includes a cryptographically strong checksum, it is safe to disable WiredTiger's own block checksums.</p>
<h1><a class="anchor" id="encryption_nop"></a>
The nop encryption extension</h1>
<p>The "nop" encryptor is a skeleton extension into which suitable cryptographic code may be inserted. It is <a class="el" href="nop_encrypt_8c-example.html">provided as a framework</a> for developers writing custom encryptors to copy as a means of getting started. It does not do anything and should obviously not be used in production.</p>
<h1><a class="anchor" id="encryption_rotn"></a>
The rotn encryption extension</h1>
<p>The "rotn" encryptor is a test extension that performs either of two forms of trivial "encryption". It is used for testing the encryption framework. It provides no security and should never be used in production.</p>
<h1><a class="anchor" id="encryption_ex"></a>
The ex_encrypt example</h1>
<p>The <a class="el" href="ex_encrypt_8c-example.html">ex_encrypt.c</a> example (mentioned above) provides a runnable example of a simple application that loads a custom encryptor compiled into the application (rather than as a plugin library). The "encryption" it uses is trivial and should never be used in production.</p>
<dl class="section warning"><dt>Warning</dt><dd>Developers writing custom encryptor extensions should be sure to consult appropriate references to ensure that what they do is cryptographically sound and addresses the threat model they have in mind. Proper use of cryptographic primitives and constructions is a complex topic far beyond the scope of this documentation. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__wt_html_gacbe8d118f978f5bfc8ccb4c77c9e8813"><div class="ttname"><a href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813">wiredtiger_open</a></div><div class="ttdeci">int wiredtiger_open(const char *home, WT_EVENT_HANDLER *event_handler, const char *config, WT_CONNECTION **connectionp)</div><div class="ttdoc">Open a connection to a database.</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
