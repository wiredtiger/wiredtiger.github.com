<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Performance Monitoring</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.0</span>
   </div>
   <div id="projectbrief"><!-- 10.0.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('devdoc-perf.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Performance Monitoring </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Overview</h1>
<p>Linux <code>perf</code> is a tool that allows counting and sampling of various events in the hardware and in the kernel. Hardware events are available via performance monitoring units (PMU); they measure CPU cycles, cache misses, branches, etc. Kernel events include scheduling context switches, page faults, block I/O, etc.</p>
<p><code>perf</code> is good for answering these and similar questions:</p>
<ul>
<li>What is the breakdown of CPU time (or cache misses or branch mispredictions) by function?</li>
<li>What was the total number of page faults generated by two different runs of my program?</li>
<li>How many context switches occurred during the execution?</li>
<li>How many times did my program issued a <code>sched_yield</code> system call?</li>
<li>Which functions triggered most page faults?</li>
<li>How much block I/O did my program generate?</li>
</ul>
<p>Despite <a href="https://perf.wiki.kernel.org/index.php/Tutorial#Profiling_sleep_times">claims that perf can also tell you where and why your program was blocking</a>, I was not able to get it to do so after many attempts. For alternative ways to perform off-CPU analysis, read <a href="http://www.brendangregg.com/offcpuanalysis.html">this post by Brendan Gregg</a> or use WiredTiger's <a class="el" href="devdoc-optrack.html">Operation Tracking</a>.</p>
<p>What follows is a quick cheat sheet of how to use <code>perf</code> with WiredTiger. Most of the information in this cheat sheet comes from <a href="http://www.brendangregg.com/perf.html">this excellent tutorial by Brendan Gregg</a>. If you need more information, please refer to that source.</p>
<h1>Running perf with WiredTiger</h1>
<p>Build WiredTiger as usual. You do not need to add any special compilation flags.</p>
<p>To run <code>perf</code> with WiredTiger, you simply insert the name of the <code>perf</code> command before the WiredTiger executable. For example, if you want to record default <code>perf</code> statistics for a <code>wtperf</code> job, you'd run: </p><pre class="fragment">perf stat wtperf &lt;wtperf options&gt;
</pre><p>If you want to profile CPU time of <code>wtperf</code>, you'd run: </p><pre class="fragment">perf record wtperf &lt;wtperf options&gt;
</pre><p>Any environment variables you care about will go before the <code>perf</code> command.</p>
<p>If you wanted to run <code>perf</code> on an already running WiredTiger process, you supply a <code>-p &lt;PID&gt;</code> option to either of these commands: </p><pre class="fragment">perf record -p &lt;PID&gt;
</pre><p>or </p><pre class="fragment">perf stat -p &lt;PID&gt;
</pre><h1>Counting events</h1>
<p>The command <code>perf stat</code> will report the total count of events for the entire execution. </p><pre class="fragment">perf stat wtperf &lt;wtperf options&gt;
</pre><p>By default it will report things like clock cycles, context switches, CPU migrations, page faults, cycles, instructions, branches and branch misses.</p>
<p>Here is a sample output: </p><pre class="fragment">   55275.953046      task-clock (msec)         #  1.466 CPUs utilized
      7,349,023      context-switches          #  0.133 M/sec
         38,219      cpu-migrations            #  0.691 K/sec
        160,562      page-faults               #  0.003 M/sec
173,665,597,703      cycles                    #  3.142 GHz
 90,146,578,819      instructions              #  0.52  insn per cycle
 22,199,890,600      branches                  #  401.619 M/sec
    387,770,656      branch-misses             #  1.75% of all branches

   37.710693533 seconds time elapsed
</pre><p>Alternatively, you can decide what events you want to include. For example, if you wanted to count last-level cache (LLC) misses, one way to do this is like so: </p><pre class="fragment">perf stat -e LLC-load-misses wtperf &lt;wtperf options&gt;
</pre><p>Or if you wanted all default events and all cache events, run: </p><pre class="fragment">perf stat -d wtperf &lt;wtperf options&gt;
</pre><p>To learn about all events you can count or sample with perf, use the command: </p><pre class="fragment">perf list
</pre><p>To count all system calls by type, run: </p><pre class="fragment">perf stat -e 'syscalls:sys_enter_*'
</pre><h1>Sampling events (profiling)</h1>
<p>Unlike <code>perf stat</code>, which counts all events, <code>perf record</code> samples events. The simplest way to invoke it is like so: </p><pre class="fragment">perf record &lt;command&gt;
</pre><p>This will sample on-CPU functions.</p>
<h1>Examining the output</h1>
<p>By default, the output will be placed into a file named <code>perf.data</code>. To examine it, run: </p><pre class="fragment">perf report
</pre><p><code>perf report</code> will show, for each sampled event, the call stacks that were recorded at the time of sampling. The call stacks will be sorted from the most frequently occurring to the least frequently occurring.</p>
<p>At the time of this writing, the default sampling frequency is 4000; that is, a sample is taken after every 4000 events. This number may change, so to be sure check the setting in the header in the <code>perf</code> output, like so: </p><pre class="fragment">perf report --header
</pre><p>If you want to change the output file, use the <code>-o</code> option: </p><pre class="fragment">perf record -o &lt;new_output_file&gt; &lt;command&gt;
</pre><p>And run the reporting with the <code>-i</code> option: </p><pre class="fragment">perf report -i &lt;new_output_file&gt;
</pre><p>Here is a way to look at the output with all the call stacks expanded: </p><pre class="fragment">perf report -n --stdio
</pre><h1>More examples</h1>
<p>Sample on-cpu functions with call stacks: </p><pre class="fragment">perf record -g &lt;command&gt;
</pre><p>Sample as above, but using a specific sampling frequency (99 hertz): </p><pre class="fragment">perf record -F 99 -g &lt;command&gt;
</pre><p>Sample last-level cache load misses with call stacks: </p><pre class="fragment">perf record -e LLC-load-misses -g &lt;command&gt;
</pre><p>Sample cache misses for a running process: </p><pre class="fragment">perf record -e LLC-load-misses -g -p &lt;PID&gt;
</pre><p>Sample page faults: </p><pre class="fragment">perf record -e page-faults -g</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="devdoc-index.html">Developer Documentation</a></li>
    <li class="footer">Copyright (c) 2008-2020 MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
