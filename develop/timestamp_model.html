<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Timestamp overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('timestamp_model.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Timestamp overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Some applications have their own notion of time, for example, wanting to read earlier data after a commit, or wanting to enforce an expected commit order for transactions different from the order otherwise assigned by WiredTiger. For such applications, WiredTiger provides interfaces so applications can impose their time ordering on the library. Additionally, timestamps allow applications to prepare transactions, read the database as of a given timestamp, and choose a timestamp for recovery after failure.</p>
<p>All transactions where timestamps are configured must run at snapshot isolation; reduced isolation levels are not permitted.</p>
<h1><a class="anchor" id="timestamps_global"></a>
Global timestamps</h1>
<p>Applications using timestamps need to manage some global timestamp state. These timestamps are queried using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a607cf2781661d03ba50586133e02cc11" title="Query the global transaction timestamp state.">WT_CONNECTION::query_timestamp</a> method and set using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#ad082439541b1b95d6aae6c15026fe512" title="Set a global transaction timestamp.">WT_CONNECTION::set_timestamp</a> method. See <a class="el" href="timestamp_global_api.html">Managing the global timestamp state</a> for a full explanation.</p>
<h1><a class="anchor" id="timestamp_transactions"></a>
Timestamps and transactions</h1>
<p>Individual transactions also have timestamp state. These timestamps are queried using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aeec1349581b7f97fc90573550fff8b6b" title="Query the session&#39;s transaction timestamp state.">WT_SESSION::query_timestamp</a> but are potentially set in a variety of methods, to allow configuration at various stages of the transaction: <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a7e26b16b26b5870498752322fad790bf" title="Start a transaction in this session.">WT_SESSION::begin_transaction</a>, <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2" title="Commit the current transaction.">WT_SESSION::commit_transaction</a>, <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a96b8a369610c8cbb08b8a7c504fd1008" title="Prepare the current transaction.">WT_SESSION::prepare_transaction</a> and <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f" title="Set a timestamp on a transaction.">WT_SESSION::timestamp_transaction</a>. See <a class="el" href="timestamp_txn_api.html">Managing the transaction timestamp state</a> for a full explanation.</p>
<h1><a class="anchor" id="timestamps_format"></a>
Timestamp format</h1>
<p>Timestamps are 64-bit unsigned integers naming a point in application time. WiredTiger does not interpret timestamps other than expecting larger timestamps to correspond to later times. The timestamp value of zero is reserved, timestamps must be non-zero. It is not necessary for timestamp values to be clock time of any kind; an expected timestamp source is a global counter shared by instances of an application distributed across a network, individually running local WiredTiger databases.</p>
<p>Timestamps can be read from and written to the WiredTiger API as hexadecimal strings without any leading prefix like "0x". Applications using timestamps must format those values as hexadecimal when querying or setting timestamps in WiredTiger:</p>
<div class="fragment"><div class="line">        uint64_t ts;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* 2 bytes for each byte converted to hexadecimal; sizeof includes the trailing nul byte */</span></div>
<div class="line">        <span class="keywordtype">char</span> timestamp_buf[<span class="keyword">sizeof</span>(<span class="stringliteral">&quot;commit_timestamp=&quot;</span>) + 2 * <span class="keyword">sizeof</span>(uint64_t)];</div>
<div class="line"> </div>
<div class="line">        (void)snprintf(timestamp_buf, <span class="keyword">sizeof</span>(timestamp_buf), <span class="stringliteral">&quot;commit_timestamp=%x&quot;</span>, 20u);</div>
<div class="line">        error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f">timestamp_transaction</a>(session, timestamp_buf));</div>
<div class="line"> </div>
<div class="line">        error_check(conn-&gt;<a class="code" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a607cf2781661d03ba50586133e02cc11">query_timestamp</a>(conn, timestamp_buf, <span class="stringliteral">&quot;get=all_durable&quot;</span>));</div>
<div class="line">        ts = strtoull(timestamp_buf, NULL, 16);</div>
</div><!-- fragment --><p> Also, timestamps can be written to the WiredTiger API as 64-bit unsigned integers in one fast-path case (where handling hexadecimal strings has shown itself to be a bottle-neck):</p>
<div class="fragment"><div class="line">        error_check(session-&gt;<a class="code" href="struct_w_t___s_e_s_s_i_o_n.html#a1d4d22f14aef710c0c3ac6a543004686">timestamp_transaction_uint</a>(session, <a class="code" href="group__wt.html#gga3307ac01d47089125814f62e90b6ef6ea20ed2533cb281af4aa546fd73303e3c5">WT_TS_TXN_TYPE_COMMIT</a>, 42));</div>
</div><!-- fragment --> <h1><a class="anchor" id="timestamps_durability_commit"></a>
Logged objects, commit-level durability and timestamps</h1>
<dl class="section warning"><dt>Warning</dt><dd>For all objects for which logging is configured, that is, objects configured for commit-level durability, timestamps are ignored and durability behaves as if timestamps were not set. This means timestamps do not change run-time behavior for logged objects. (For example, it is not possible to read historical data and attempts to do so are ignored.) Commits are written into the log and subsequently restored as part of database recovery, as they are without timestamps.</dd></dl>
<p>In general, timestamp-based WiredTiger applications will mostly not use commit-level durability. However, commit-level durability with timestamps makes sense when there is an object in the database that acts as a higher-level application write-ahead-log. In that case, the application's high-level log is recovered to the most recent commit and then that log is used to restore other objects in the system which used checkpoint-level durability. The log itself cannot be timestamped, but can be used to store timestamps for other data.</p>
<p>For that reason, it is not an error to modify both logged and non-logged objects in transactions configured with timestamps, as the atomicity, consistency and isolation features of ACID for all objects in the transaction are supported. However, because the underlying objects will have different durability models, applications must be prepared to handle the inconsistencies between logged and non-logged objects that will be seen after recovery.</p>
<dl class="section warning"><dt>Warning</dt><dd>Using both commit-level and checkpoint-level durability in the same database requires caution. Configuring logging for the database will automatically configure logging for each object in the database unless logging is explicitly turned off when the object is created.</dd></dl>
<h1><a class="anchor" id="timestamps_durability_checkpoint"></a>
Checkpoint durability and timestamps</h1>
<p>Checkpoint durability is the expected choice for most objects when timestamps are configured. The change from checkpoint durability without timestamps is applications can set a maximum value for the timestamp of each checkpoint (the "stable timestamp"), and during recovery objects are returned to the stable timestamp associated with the most recent checkpoint. This gives the application fine-grained control over the point to which recovery moves after failure.</p>
<dl class="section warning"><dt>Warning</dt><dd>As in checkpoint durability without timestamps, transactions committed after a checkpoint will be rolled back as part of recovery. However, with the introduction of the stable timestamp as the checkpoint's timestamp, it becomes possible for a transaction to be committed, followed by a checkpoint, and then recovery would still roll back the transaction if the commit timestamp were after the checkpoint's stable timestamp. Applications are therefore responsible for ensuring such committed transactions are restored or abandoned as desired. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="astruct_w_t___s_e_s_s_i_o_n_html_aa449082ce4de7ee86a773595c416a69f"><div class="ttname"><a href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f">WT_SESSION::timestamp_transaction</a></div><div class="ttdeci">int timestamp_transaction(WT_SESSION *session, const char *config)</div><div class="ttdoc">Set a timestamp on a transaction.</div></div>
<div class="ttc" id="agroup__wt_html_gga3307ac01d47089125814f62e90b6ef6ea20ed2533cb281af4aa546fd73303e3c5"><div class="ttname"><a href="group__wt.html#gga3307ac01d47089125814f62e90b6ef6ea20ed2533cb281af4aa546fd73303e3c5">WT_TS_TXN_TYPE_COMMIT</a></div><div class="ttdeci">@ WT_TS_TXN_TYPE_COMMIT</div><div class="ttdoc">Commit timestamp.</div><div class="ttdef"><b>Definition:</b> wiredtiger.in:738</div></div>
<div class="ttc" id="astruct_w_t___s_e_s_s_i_o_n_html_a1d4d22f14aef710c0c3ac6a543004686"><div class="ttname"><a href="struct_w_t___s_e_s_s_i_o_n.html#a1d4d22f14aef710c0c3ac6a543004686">WT_SESSION::timestamp_transaction_uint</a></div><div class="ttdeci">int timestamp_transaction_uint(WT_SESSION *session, WT_TS_TXN_TYPE which, uint64_t ts)</div><div class="ttdoc">Set a timestamp on a transaction numerically.</div></div>
<div class="ttc" id="astruct_w_t___c_o_n_n_e_c_t_i_o_n_html_a607cf2781661d03ba50586133e02cc11"><div class="ttname"><a href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a607cf2781661d03ba50586133e02cc11">WT_CONNECTION::query_timestamp</a></div><div class="ttdeci">int query_timestamp(WT_CONNECTION *connection, char *hex_timestamp, const char *config)</div><div class="ttdoc">Query the global transaction timestamp state.</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
