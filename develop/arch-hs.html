<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: History Store</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('arch-hs.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">History Store </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="arch_head"><table class="doxtable">
<tr>
<th rowspan="2" style="width:10%;"> <div><a href="arch-index.html"><img class="arch_thumbnail" src="wt_diagram.png" usemap="#wt_diagram_map" style="background-image: url(wt_diagram.png)"></a></div></th><th style="width:44%">Data Structures</th><th style="width:45%">Source Location</th></tr>
<map id="wt_diagram_map" name="wt_diagram_map">
<area shape="rect" id="id1" href="modules.html" title="modules.html" alt="" coords="248,128,283,144"/>
<area shape="rect" id="id2" href="arch-cache.html" title="arch-cache.html" alt="" coords="204,546,248,562"/>
<area shape="rect" id="id3" href="arch-cursor.html" title="arch-cursor.html" alt="" coords="234,224,280,240"/>
<area shape="rect" id="id4" href="arch-eviction.html" title="arch-eviction.html" alt="" coords="303,546,356,562"/>
<area shape="rect" id="id5" href="arch-logging.html" title="arch-logging.html" alt="" coords="388,650,443,666"/>
<area shape="rect" id="id6" href="arch-schema.html" title="arch-schema.html" alt="" coords="123,224,179,240"/>
<area shape="rect" id="id7" href="command_line.html" title="command_line.html" alt="" coords="374,23,430,39"/>
<area shape="rect" id="id8" href="arch-log-file.html" title="arch-log-file.html" alt="" coords="308,865,339,897"/>
<area shape="rect" id="id9" href="arch-metadata.html" title="arch-metadata.html" alt="" coords="25,328,89,344"/>
<area shape="rect" id="id10" href="arch-python.html" title="arch-python.html" alt="" coords="84,23,157,39"/>
<area shape="rect" id="id11" href="arch-snapshot.html" title="arch-snapshot.html" alt="" coords="297,441,371,457"/>
<area shape="rect" id="id12" href="arch-transaction.html" title="arch-transaction.html" alt="" coords="298,328,387,344"/>
<area shape="rect" id="id13" href="arch-hs.html" title="arch-hs.html" alt="" coords="93,642,140,674"/>
<area shape="rect" id="id14" href="arch-block.html" title="arch-block.html" alt="" coords="196,642,256,674"/>
<area shape="rect" id="id15" href="arch-dhandle.html" title="arch-dhandle.html" alt="" coords="144,320,205,352"/>
<area shape="rect" id="id16" href="arch-data-file.html" title="arch-data-file.html" alt="" coords="179,865,245,897"/>
<area shape="rect" id="id17" href="arch-row-column.html" title="arch-row-column.html" alt="" coords="117,433,205,465"/>
<area shape="rect" id="id18" href="arch-fs-os.html" title="arch-fs-os.html" alt="" coords="175,755,357,771"/>
</map>
<tr>
<td><code><code>WT_CURSOR_HS</code></code></td><td><code><code>src/history/</code></code></td></tr>
</table>
</div><p> <b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<p>The history store in WiredTiger tracks historical versions of records required to service older readers. By having these records in storage separate from the current version, they can be used to service long running transactions and be evicted as necessary, without interfering with activity that uses the most recent committed versions. With the introduction of history store, only the newest update to a key is written to the user table while the older updates for the key are written to the history store. All user tables in the database are backed by a single history store table. The history store has no outward visibility to the application code and only WiredTiger's internal modules can perform operations on the history store table using a predefined cursor API.</p>
<h1><a class="anchor" id="arch_hs_table"></a>
History store table structure</h1>
<p>WiredTiger writes the history store on the disk as a standard row-store table. The key for the history store table is a combination of:</p><ul>
<li>btree ID of user table this update belongs to</li>
<li>record key (byte-string for row-store, record number for column-store)</li>
<li>start timestamp for the update</li>
<li>counter value</li>
</ul>
<p>This key format allows us to search efficiently for a given record key and read timestamp combination. The last part of the key is a monotonically increasing counter to keep the key unique in scenarios where a key has multiple updates with the same commit timestamp. As the key for the history store table is different for row- and column-store, we store both key types in a byte string otherwise we'd need two history store files with different key formats.</p>
<p>The corresponding value for each key is stored as a combination of:</p><ul>
<li>stop timestamp</li>
<li>durable timestamp</li>
<li>update type</li>
<li>value</li>
</ul>
<h2><a class="anchor" id="arch_hs_table_tombstone"></a>
Tombstones in the history store table</h2>
<p>The stop timestamp refers to the point in time after which the update is no longer visible. This can either be a result of deletion or of a new update being committed. An update with a valid stop time is also called a <code>tombstone</code>. Every update in the history store has a valid stop timestamp and transaction id associated with it, except for cases where the update preceded a prepared update. The stop timestamp of the update immediately before the prepared update is set to the maximum possible timestamp (<code>WT_TS_MAX</code>). The stop timestamp of the latest update in the history store is updated once the prepared update is resolved. A tombstone becomes globally visible if the stop timestamp is less than the oldest timestamp and the stop transaction id is visible to all concurrent transactions in the system. A checkpoint can delete history store pages that only contain globally visible tombstones. The garbage collection process is discussed in <a class="el" href="arch-checkpoint.html">Checkpoint</a>.</p>
<h1><a class="anchor" id="arch_hs_initialize"></a>
History store initialization</h1>
<p>WiredTiger checks for an existing history store table at startup and creates a new table if it is not able to find one. The history store table is usually created when WiredTiger creates a new database, with one exception where WiredTiger is opening an existing database created by an older version of WiredTiger that doesn't support the history store. WiredTiger uses <code>WiredTigerHS.wt</code> as the filename for the history store table.</p>
<h1><a class="anchor" id="arch_hs_cursor"></a>
History store cursor interface</h1>
<p>WiredTiger uses a cursor interface for history store table to make it easier for different modules to perform data operations on the history store table. A new cursor can be opened by calling <code>__wt_curhs_open()</code>. History store cursor implementation supports most of the standard <code><a class="el" href="struct_w_t___c_u_r_s_o_r.html" title="A WT_CURSOR handle is the interface to a cursor.">WT_CURSOR</a></code> methods except for <code><a class="el" href="struct_w_t___c_u_r_s_o_r.html#a7e25b2ced2cf3ec68bd5429bf921c79f" title="Return the record matching the key.">WT_CURSOR::search()</a></code> method. Recall that the key contains a counter and timestamp value and it is expected that the caller can not possibly know the exact values for both fields beforehand. Therefore, <code><a class="el" href="struct_w_t___c_u_r_s_o_r.html#a8068ddce20d0775f26f6dac6e5eb209c" title="Return the record matching the key if it exists, or an adjacent record.">WT_CURSOR::search_near()</a></code> is used for all search operations. Two helper functions, <code>__wt_curhs_search_near_before()</code> and <code>__wt_curhs_search_near_after()</code>, have been provided to facilitate searching for the required record in the history store table.</p>
<h1><a class="anchor" id="arch_hs_cursor_visibility"></a>
History store cursor interface and visibility rules</h1>
<p>When using the history store cursor interface, the user can configure the type of visibility checks that are performed on the records. The behavior is controlled by a set of cursor flags:</p>
<ul>
<li>By default, snapshot based visibility checks are performed on all records returned to the API user.</li>
<li>When the flag <code>WT_CURSTD_HS_READ_ALL</code> is set on the cursor, no visibility checks are performed on the records returned to the API user. This means that cursor interface can even return a record with a globally visible tombstone. When this flag is set, it suppresses the effect of other visibility flags.</li>
<li>When the flag <code>WT_CURSTD_HS_READ_COMMITTED</code> is set, the cursor interface can return any record except for globally deleted records. This flag has no effect when the flag <code>WT_CURSTD_HS_READ_ALL</code> is set.</li>
</ul>
<p>History store cursor users must use one of the flags if the caller thread is running in a lower isolation level and doesn't hold a valid snapshot.</p>
<h1><a class="anchor" id="arch_hs_reconciliation"></a>
History store and reconciliation</h1>
<p>When a dirty page is reconciled on a user file btree, the update chain is examined and the latest committed update is chosen as the on-disk value. All older updates are added to the history store table assuming they are not yet obsolete. Additionally any out of order timestamps will be corrected.</p>
<p>Consider the following update chain for a user table with btree id 1000 and data store key "AAA":</p>
<div class="image">
<img src="hs_update_chain.png" alt=""/>
</div>
 <p>Assuming all updates are committed, updates <code>U1</code>, <code>U2</code> and <code>U3</code> will be added to the history store table as shown in the table below.</p>
<table style="height: 195px; width: 811px; border-color: Black;" border="4">
<tr style="height: 32px;">
<td style="width: 353.391px; height: 32px; text-align: center;" colspan="4"><b>KEY</b>  </td><td style="width: 456.609px; height: 32px; text-align: center;" colspan="4"><b>VALUE</b>   </td></tr>
<tr style="height: 32px;">
<td style="width: 72.5156px; height: 32px; text-align: center;"><b>Btree ID</b>  </td><td style="width: 89.875px; height: 32px; text-align: center;"><b>User Key</b>  </td><td style="width: 97.0312px; height: 32px; text-align: center;"><b>Start ts</b>  </td><td style="width: 93.9688px; height: 32px; text-align: center;"><b>Counter</b>  </td><td style="width: 92.4375px; height: 32px; text-align: center;"><b>Stop ts</b>  </td><td style="width: 105.719px; height: 32px; text-align: center;"><b>Durable ts</b>  </td><td style="width: 110.312px; height: 32px; text-align: center;"><b>Type</b>  </td><td style="width: 148.141px; height: 32px; text-align: center;"><b>Value</b>   </td></tr>
<tr style="height: 32.5625px;">
<td style="width: 72.5156px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 89.875px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 97.0312px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 93.9688px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 92.4375px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 105.719px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 110.312px; height: 32.5625px; text-align: center;"><b>...</b>  </td><td style="width: 148.141px; height: 32.5625px; text-align: center;"><b>...</b>   </td></tr>
<tr style="height: 32px;">
<td style="width: 72.5156px; height: 32px; text-align: center;">1000 </td><td style="width: 89.875px; height: 32px; text-align: center;">"AAA" </td><td style="width: 97.0312px; height: 32px; text-align: center;">70 </td><td style="width: 93.9688px; height: 32px; text-align: center;">0 </td><td style="width: 92.4375px; height: 32px; text-align: center;">80 </td><td style="width: 105.719px; height: 32px; text-align: center;">70 </td><td style="width: 110.312px; height: 32px; text-align: center;">STANDARD </td><td style="width: 148.141px; height: 32px; text-align: center;">Value from U1  </td></tr>
<tr style="height: 32px;">
<td style="width: 72.5156px; height: 32px; text-align: center;">1000 </td><td style="width: 89.875px; height: 32px; text-align: center;">"AAA" </td><td style="width: 97.0312px; height: 32px; text-align: center;">80 </td><td style="width: 93.9688px; height: 32px; text-align: center;">0 </td><td style="width: 92.4375px; height: 32px; text-align: center;">90 </td><td style="width: 105.719px; height: 32px; text-align: center;">80 </td><td style="width: 110.312px; height: 32px; text-align: center;">STANDARD </td><td style="width: 148.141px; height: 32px; text-align: center;">Value from U2  </td></tr>
<tr style="height: 32px;">
<td style="width: 72.5156px; height: 32px; text-align: center;">1000 </td><td style="width: 89.875px; height: 32px; text-align: center;">"AAA" </td><td style="width: 97.0312px; height: 32px; text-align: center;">90 </td><td style="width: 93.9688px; height: 32px; text-align: center;">0 </td><td style="width: 92.4375px; height: 32px; text-align: center;">100 </td><td style="width: 105.719px; height: 32px; text-align: center;">90 </td><td style="width: 110.312px; height: 32px; text-align: center;">STANDARD </td><td style="width: 148.141px; height: 32px; text-align: center;">Value from U3  </td></tr>
<tr style="height: 32px;">
<td style="width: 72.5156px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 89.875px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 97.0312px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 93.9688px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 92.4375px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 105.719px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 110.312px; height: 32px; text-align: center;"><b>...</b>  </td><td style="width: 148.141px; height: 32px; text-align: center;"><b>...</b>   </td></tr>
</table>
<p>For the history store table entry corresponding to the update <code>U1</code>, the start timestamp in the key is the start timestamp for the update <code>U1</code> and the stop timestamp in the value is the start timestamp for the update <code>U2</code>.</p>
<p>When a modified history store table page is processed by reconciliation, a new page image is created without records which have globally visible tombstones. This ensures that WiredTiger is only keeping the relevant historical data required to serve the oldest reader in the system or as dictated by the oldest timestamp set by the application. Once all records on a page are obsolete, the page itself can be removed to reduce the size of the history store table (see <a class="el" href="arch-transaction.html">Transaction</a> for more details about oldest timestamp).</p>
<h1><a class="anchor" id="arch_hs_read"></a>
Searching for older versions of a key in History Store</h1>
<p>When looking for an update visible to the current transaction, WiredTiger first searches the update chain for any visible updates. If there is no visible update in the chain, WiredTiger then inspects the on-disk version of the key. If that version is not visible to the transaction, WiredTiger searches the history store table for a visible update for the key. When searching for an update that satisfies the read timestamp constraint, WiredTiger starts with the newest update of the key in the history store table and then iterates through the older updates until there are no updates left to process. Note that although there can be multiple updates in the history store for a key and read timestamp combination, each update would have different visibility based on transaction and timestamp based visibility rules. In case there are no records visible in the history store table, <code>WT_NOTFOUND</code> error is returned to the reader.</p>
<h1><a class="anchor" id="arch_hs_rts"></a>
History store and rollback to stable</h1>
<p><a class="el" href="arch-rts.html">Rollback to stable</a> searches the history store table for valid updates that are stable according to the supplied stable timestamp and replaces the on-disk version with an update from the history store table that fulfills the criteria. Rollback to stable also removes updates from the history store table that are not stable according to the stable timestamp and transaction snapshot being used for rollback to stable operation.</p>
<h1><a class="anchor" id="arch_hs_prepared"></a>
History store and prepared transactions</h1>
<p>When there is a prepared update for a key and the page is evicted, the prepared update is written to the on-disk page and any older updates are written to the history store table. There can be no update from a different transaction that is newer than the prepared update for the key and therefore the history store should never contain a prepared update. When a prepared update is committed, the stop timestamp of the newest update in the history store table is updated from <code>WT_TS_MAX</code> to the commit timestamp of the prepared update. When a prepared update is rolled back, the newest update from the history store table is restored as the on-disk version and then removed from the history store table. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-on-disk.html">On Disk Concepts</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
