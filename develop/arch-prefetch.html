<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Pre-fetch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.3.1</span>
   </div>
   <div id="projectbrief"><!-- 11.3.1 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('arch-prefetch.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Pre-fetch </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="arch_head"><table class="doxtable">
<tr>
<th rowspan="2" style="width:10%;"> <div><a href="arch-index.html"><img class="arch_thumbnail" src="wt_diagram.png" usemap="#wt_diagram_map" style="background-image: url(wt_diagram.png)"></a></div></th><th style="width:44%">Data Structures</th><th style="width:45%">Source Location</th></tr>
<map id="wt_diagram_map" name="wt_diagram_map">
<area shape="rect" id="id1" href="modules.html" title="modules.html" alt="" coords="248,128,283,144"/>
<area shape="rect" id="id2" href="arch-cache.html" title="arch-cache.html" alt="" coords="204,546,248,562"/>
<area shape="rect" id="id3" href="arch-cursor.html" title="arch-cursor.html" alt="" coords="234,224,280,240"/>
<area shape="rect" id="id4" href="arch-eviction.html" title="arch-eviction.html" alt="" coords="303,546,356,562"/>
<area shape="rect" id="id5" href="arch-logging.html" title="arch-logging.html" alt="" coords="388,650,443,666"/>
<area shape="rect" id="id6" href="arch-schema.html" title="arch-schema.html" alt="" coords="123,224,179,240"/>
<area shape="rect" id="id7" href="command_line.html" title="command_line.html" alt="" coords="374,23,430,39"/>
<area shape="rect" id="id8" href="arch-log-file.html" title="arch-log-file.html" alt="" coords="308,865,339,897"/>
<area shape="rect" id="id9" href="arch-metadata.html" title="arch-metadata.html" alt="" coords="25,328,89,344"/>
<area shape="rect" id="id10" href="arch-python.html" title="arch-python.html" alt="" coords="84,23,157,39"/>
<area shape="rect" id="id11" href="arch-snapshot.html" title="arch-snapshot.html" alt="" coords="297,441,371,457"/>
<area shape="rect" id="id12" href="arch-transaction.html" title="arch-transaction.html" alt="" coords="298,328,387,344"/>
<area shape="rect" id="id13" href="arch-hs.html" title="arch-hs.html" alt="" coords="93,642,140,674"/>
<area shape="rect" id="id14" href="arch-block.html" title="arch-block.html" alt="" coords="196,642,256,674"/>
<area shape="rect" id="id15" href="arch-dhandle.html" title="arch-dhandle.html" alt="" coords="144,320,205,352"/>
<area shape="rect" id="id16" href="arch-data-file.html" title="arch-data-file.html" alt="" coords="179,865,245,897"/>
<area shape="rect" id="id17" href="arch-row-column.html" title="arch-row-column.html" alt="" coords="117,433,205,465"/>
<area shape="rect" id="id18" href="arch-fs-os.html" title="arch-fs-os.html" alt="" coords="175,755,357,771"/>
</map>
<tr>
<td><code><code>WT_PREFETCH<br  />
WT_PREFETCH_QUEUE_ENTRY<br  />
WT_REF</code></code></td><td><code><code>src/btree/bt_prefetch.c<br  />
src/conn/conn_prefetch.c<br  />
src/session/session_prefetch.c</code></code></td></tr>
</table>
</div><p> <b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<h1><a class="anchor" id="prefetch_overview"></a>
What is pre-fetching? When is pre-fetching useful?</h1>
<p>Database records must be in memory before WiredTiger can operate on them, but if that record is initially on disk, WiredTiger needs to perform an expensive I/O operation to fetch the record. Instead of performing I/O on demand, WiredTiger can be configured to predict which records are about to be accessed and speculatively load (pre-fetch) the corresponding page, hiding the I/O delays from the user.</p>
<p>Applications access the database in different ways, and so it is not necessarily ideal to always enable pre-fetching. Pre-fetching is beneficial when an operation has locality of reference and it is reasonably likely that the application will access data in a sequential way. When future operations are likely to access data that is near the data currently being accessed, WiredTiger can predict which pages will be needed soon and pre-emptively read them into the cache.</p>
<h1><a class="anchor" id="prefetch_algorithm"></a>
Pre-fetch Algorithm</h1>
<ol type="1">
<li>The main application thread finds candidate pages for pre-fetching as it traverses the B-tree.</li>
<li>It populates the pre-fetch queue with these candidate pages.</li>
<li>Pre-fetch worker threads will pop off pages from the pre-fetch queue and read pages into the cache.</li>
</ol>
<h2><a class="anchor" id="prefetch_algorithm_find_pages"></a>
Finding Candidate Pages</h2>
<p>Pre-fetch looks for potential candidate pages in two places: (1) while walking the B-tree (<code>__tree_walk_internal</code>) and (2) when verifying a tree (<code>__verify_tree</code>). The <code>__wt_session_prefetch_check</code> function contains a few checks to decide if pre-fetching should be performed for a given <code>ref</code>. Pre-fetching does not operate on internal pages, and should not be performed until we have triggered at least two leaf page reads from sequential read requests. Pre-fetching is also disabled for tiered tables, and special operations with the exception of verify.</p>
<h2><a class="anchor" id="prefetch_algorithm_populate_queue"></a>
Populating the Pre-fetch Queue</h2>
<p>The pre-fetch queue is a first-in-first-out (FIFO) data structure containing the page references of potential pre-fetch candidates. The <code>__wti_btree_prefetch</code> function is responsible for pushing candidate pages onto the queue. Given a <code>ref</code>, it will queue the next set of pages if they are leaf pages, not already in the cache, and not already on the pre-fetch queue. To prevent overloading the pre-fetch queue, there is a maximum number of candidate pages allowed in the queue (<code>WT_MAX_PREFETCH_QUEUE</code>), and a limit on the maximum number of pages we can add to the queue during a pre-fetch check (<code>WT_PREFETCH_QUEUE_PER_TRIGGER</code>). Pages will not be added to the queue if either of these conditions are met.</p>
<h2><a class="anchor" id="prefetch_algorithm_process_pages"></a>
Pre-fetching Content Into the Cache</h2>
<p>Pre-fetch worker threads are responsible for the work of reading page contents into the cache. The <code>__wt_prefetch_thread_run</code> function is the entry point for a pre-fetch thread, and threads will continue to run while the pre-fetch queue is not empty. When there are no more pre-fetch entries to process, pre-fetch worker threads wait on a condition variable that signals when an entry has been pushed onto the pre-fetch queue. Pre-fetch worker threads invoke the <code>__wt_page_in</code> function which reads the page from disk and builds an in-memory representation.</p>
<h1><a class="anchor" id="prefetch_api"></a>
Pre-fetch API</h1>
<h2><a class="anchor" id="prefetch_api_connection"></a>
Connection-Level Configuration</h2>
<p><code>wiredtiger_open</code>("prefetch=(available=true,default=false)")</p>
<p>The <code>available</code> setting determines whether the pre-fetching functionality can be enabled for the given database, and starts up the pool of pre-fetching threads if it is turned on. The <code>default</code> setting determines whether pre-fetching is turned on or off for all sessions belonging to the connection.</p>
<h2><a class="anchor" id="prefetch_api_session"></a>
Session-Level Configuration</h2>
<p><code><a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#adad5965cd4a60f65b5ac01f7ca6d1fc0" title="Open a session.">WT_CONNECTION.open_session</a></code>("prefetch=(enabled=true)")</p>
<p>The session-level configuration can be used to override the connection-level configuration for specific sessions if desired.</p>
<h1><a class="anchor" id="prefetch_other"></a>
Interaction With Other Components</h1>
<h2><a class="anchor" id="prefetch_other_cache_busyness"></a>
Considering Current Cache Busyness</h2>
<p>Cache busyness increases in proportion to the eviction workload and the rate of pages being read into the cache. It is important to consider how pre-fetch impacts cache utilization as it may leave the cache in a state that increases operational latency. Pre-fetch stops adding page references to the queue as soon as it detects that we are close to hitting the eviction clean trigger. It will also skip processing page references that are being retrieved from the queue until space in the cache clears up.</p>
<h2><a class="anchor" id="prefetch_other_refs"></a>
Ensuring References on the Pre-fetch Queue Remain Valid</h2>
<p>Page references on the pre-fetch queue may become invalid if other operations that modify page references are happening in parallel. Eviction is not allowed to operate on any page references that are on the pre-fetch queue, because it may split pages and free the underlying ref/s. Since eviction has no way to coordinate with the queue to indicate references are no longer valid and should be removed, we take a conservative approach by preventing eviction on these refs. This condition is checked with the <code>WT_REF_FLAG_PREFETCH</code> flag. On top of this, the pre-fetch flag also guarantees that the corresponding parent page cannot be evicted until pre-fetch has processed the leaf page.</p>
<h2><a class="anchor" id="prefetch_other_concurrency"></a>
Concurrency</h2>
<p>Pre-fetch is a highly concurrent module and we rely on a few mechanisms to ensure that it runs smoothly with the rest of the system.</p><ul>
<li>A connection level lock <code>prefetch_lock</code> is used for the pre-fetch queue, and is needed when adding and removing <code>WT_PREFETCH_QUEUE_ENTRY</code> items from it.</li>
<li>Whenever we modify a <code>ref</code> structure, e.g. when adding it to the pre-fetch queue and setting the corresponding <code>WT_REF_FLAG_PREFETCH</code> flag, it must be in the <code>WT_REF_LOCKED</code> state.</li>
<li>There are scenarios which fall outside of the typical eviction flow, where pages can be forcibly removed from the cache if eviction has exclusive eviction access to that file (see <code>__wt_evict_file_exclusive_on</code>). When this occurs, we need to remove all page references associated with that file's tree from the pre-fetch queue because the system may evict internal pages which still have child pages present on the queue. The <code>prefetch_busy</code> variable on the <code>WT_BTREE</code> data structure keeps track of pre-fetch threads operating on that tree. When clearing pages from the pre-fetch queue belonging to a certain tree, we wait for any other concurrent pre-fetch activity to drain to prevent invalid ref accesses. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-mem-disk.html">Moving Data Between Memory and Disk</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
