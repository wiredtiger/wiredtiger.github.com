<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Managing the global timestamp state</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 10.0.2</span>
   </div>
   <div id="projectbrief"><!-- 10.0.2 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('timestamp_global_api.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Managing the global timestamp state </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Applications using timestamps need to manage the global timestamp state. These timestamps are queried using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a607cf2781661d03ba50586133e02cc11" title="Query the global transaction timestamp state.">WT_CONNECTION::query_timestamp</a> method and set using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#ad082439541b1b95d6aae6c15026fe512" title="Set a global transaction timestamp.">WT_CONNECTION::set_timestamp</a> method.</p>
<p>Applications will generally focus on two of these global timestamps: first, the beginning of the database's read window, called <code>oldest_timestamp</code>, and second, the application time at which data is known to be stable and will never be rolled back, called <code>stable_timestamp</code>.</p>
<p>The oldest timestamp is the oldest time at which a transaction is allowed to read. The historic values of data modified before this time can no longer be read by new transactions. Transactions already in progress are not affected when the <code>oldest_timestamp</code> changes.</p>
<p>The stable timestamp is the earliest time at which data is considered stable. (Data is said to be stable when it is not only durable, but additionally, transactions committed at or before the stable time cannot be rolled back by application-level transaction management.) The stable timestamp is saved along with every checkpoint, and that saved time is the point to which the database is recovered after a crash. It is also the earliest point to which the database can be returned via an explicit <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a93dbc74accb426582b3c5c2f69e04b28" title="Rollback tables to an earlier point in time, discarding all updates to checkpoint durable tables that...">WT_CONNECTION::rollback_to_stable</a> call. (See <a class="el" href="timestamp_misc.html#timestamp_misc_rts">Using rollback-to-stable with timestamps</a>.) All transactions must commit after the current <code>stable</code> timestamp.</p>
<p>Applications are responsible for managing these timestamps and periodically updating them.</p>
<p>Note that updating the stable timestamp does not itself trigger a database checkpoint or change data durability; updates before the new stable timestamp become stable (and thus visible after recovery) as part of the next checkpoint.</p>
<h1><a class="anchor" id="timestamp_global_setting_timestamps"></a>
Setting global timestamps</h1>
<p>The following table lists the global timestamps an application can set using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#ad082439541b1b95d6aae6c15026fe512" title="Set a global transaction timestamp.">WT_CONNECTION::set_timestamp</a> method, including constraints.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraints </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">durable_timestamp </td><td class="markdownTableBodyNone">none </td><td class="markdownTableBodyNone">temporarily set the system's maximum durable timestamp, bounding the timestamp returned by <code>all_durable</code>.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">oldest_timestamp </td><td class="markdownTableBodyNone">&lt;= stable; may not move backward, set to the value as of the last checkpoint during recovery </td><td class="markdownTableBodyNone">Inform the system future reads and writes will never be earlier than the specified timestamp.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">stable_timestamp </td><td class="markdownTableBodyNone">may not move backward, set to the stable timestamp during rollback-to-stable and recovery </td><td class="markdownTableBodyNone">Inform the system checkpoints should not include commits newer than the specified timestamp.  </td></tr>
</table>
<h2><a class="anchor" id="timestamp_global_set_api_durable_timestamp"></a>
Setting the global "durable_timestamp" timestamp</h2>
<p>The global <code>durable_timestamp</code> temporarily sets the system's maximum durable timestamp, bounding the timestamp returned when querying the <code>all_durable</code> timestamp (see below). Note that the "system's maximum durable timestamp" is the maximum durable timestamp of any committed transaction, and <b>not</b> the timestamp of data changes which have made it to stable storage.</p>
<p>The <code>durable_timestamp</code> is advanced to the transaction's durable timestamp (or the transaction's commit timestamp, if no durable timestamp was set), by any transaction commit with a durable (commit) timestamp after the current value.</p>
<p>The <code>durable_timestamp</code> is set to the stable timestamp whenever the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a93dbc74accb426582b3c5c2f69e04b28" title="Rollback tables to an earlier point in time, discarding all updates to checkpoint durable tables that...">WT_CONNECTION::rollback_to_stable</a> method is called.</p>
<dl class="section warning"><dt>Warning</dt><dd>The <code>durable</code> timestamp is used by the MongoDB server and is generally not expected to be useful to other applications.</dd></dl>
<h2><a class="anchor" id="timestamp_global_set_api_oldest_timestamp"></a>
Setting the "oldest_timestamp" timestamp</h2>
<p>Setting <code>oldest_timestamp</code> indicates future read timestamps will be at least as recent as the timestamp, allowing WiredTiger to discard history before the specified point. It is not required that there be no currently active readers at earlier timestamps: this setting only indicates future application needs. In other words, as active readers age out of the system, historic data up to the oldest timestamp may be discarded, but no historic data at or after the <code>oldest</code> timestamp will be discarded. Retaining history can be expensive in terms of both disk and I/O resources.</p>
<p>During recovery, the <code>oldest_timestamp</code> is set to its value as of the checkpoint to which recovery is done.</p>
<p>Attempting to set the <code>oldest_timestamp</code> to a value earlier than its current value will be silently ignored.</p>
<p>The <code>oldest_timestamp</code> must be less than or equal to the <code>stable_timestamp</code>.</p>
<h2><a class="anchor" id="timestamp_global_set_api_stable_timestamp"></a>
Setting the "stable_timestamp" timestamp</h2>
<p>The <code>stable_timestamp</code> determines the timestamp for subsequent checkpoints. In other words, updates to an object after the stable timestamp will not be included in a future checkpoint. Because tables in a timestamp world are generally using checkpoint durability, the <code>stable_timestamp</code> also determines the point to which recovery will be done after failures.</p>
<p>During recovery, the <code>stable_timestamp</code> is set to the value to which recovery is performed.</p>
<p>It is possible to explicitly roll back to a time after, or equal to, the current <code>stable_timestamp</code> using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a93dbc74accb426582b3c5c2f69e04b28" title="Rollback tables to an earlier point in time, discarding all updates to checkpoint durable tables that...">WT_CONNECTION::rollback_to_stable</a> method. (See <a class="el" href="timestamp_misc.html#timestamp_misc_rts">Using rollback-to-stable with timestamps</a>.)</p>
<p>The <code>stable_timestamp</code> should be updated frequently as it determines the amount of work required after recovery to bring the system online.</p>
<p>Attempting to set the <code>stable_timestamp</code> to a value earlier than its current value will be silently ignored.</p>
<p>Using the stable timestamp in the checkpoint is not required, and can be overridden using the <code>use_timestamp=false</code> configuration of the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a6550c9079198955c5071583941c85bbf" title="Write a transactionally consistent snapshot of a database or set of individual objects.">WT_SESSION::checkpoint</a> call. This is not intended for general use, but can be useful for backup scenarios where rolling back to a stable timestamp isn't possible and it's useful for a checkpoint to contain the most recent possible data.</p>
<h1><a class="anchor" id="timestamp_global_querying_timestamps"></a>
Querying global timestamps</h1>
<p>The following table lists the global timestamps an application can query using the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a607cf2781661d03ba50586133e02cc11" title="Query the global transaction timestamp state.">WT_CONNECTION::query_timestamp</a> method, including constraints. In all cases, a timestamp of 0 is returned if the timestamp is not available or has not been set, for example, the <code>last_checkpoint</code> timestamp if no checkpoints have run, or <code>oldest_reader</code> if there are no active transactions.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraints </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">all_durable </td><td class="markdownTableBodyNone">None </td><td class="markdownTableBodyNone">The largest timestamp such that all timestamps up to that value have been made durable, bounded by the <code>durable</code> timestamp.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">last_checkpoint </td><td class="markdownTableBodyNone">&lt;= stable </td><td class="markdownTableBodyNone">The stable timestamp at which the last checkpoint ran.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">oldest_reader </td><td class="markdownTableBodyNone">None </td><td class="markdownTableBodyNone">The timestamp of the oldest currently active read transaction.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">oldest_timestamp </td><td class="markdownTableBodyNone">&lt;= stable </td><td class="markdownTableBodyNone">The current application-set <code>oldest_timestamp</code> value.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">pinned </td><td class="markdownTableBodyNone">&lt;= oldest </td><td class="markdownTableBodyNone">The minimum of the <code>oldest_timestamp</code> and the oldest active reader.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">recovery </td><td class="markdownTableBodyNone">&lt;= stable </td><td class="markdownTableBodyNone">The stable timestamp used in the most recent checkpoint prior to the last shutdown.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">stable_timestamp </td><td class="markdownTableBodyNone">None </td><td class="markdownTableBodyNone">The current application-set <code>stable_timestamp</code> value.  </td></tr>
</table>
<h2><a class="anchor" id="timestamp_global_query_api_all_durable"></a>
Reading the "all_durable" timestamp</h2>
<p>The <code>all_durable</code> timestamp is the minimum of the global <code>durable_timestamp</code> value and a durable timestamp before any unresolved transaction in the system.</p>
<p>For example:</p><ul>
<li>If a transaction commits with a durable timestamp of 50 and there are no running transactions in the system, <code>all_durable</code> will return 50.</li>
<li>If a transaction commits with a durable timestamp of 50, and there is an unresolved transaction with a durable timestamp of 40, <code>all_durable</code> will return 39.</li>
<li>If a transaction commits with a durable timestamp of 50 and there are no running transactions in the system and the application sets <code>durable_timestamp</code> to 30, <code>all_durable</code> will return 30.</li>
<li>If a transaction commits with a durable timestamp of 50, and there is an unresolved transaction with a durable timestamp of 20 and the application sets <code>durable_timestamp</code> to 30, <code>all_durable</code> will return 19.</li>
<li>If the application sets <code>durable_timestamp</code> to 30, and a transaction then commits with a durable timestamp of 50, <code>all_durable</code> will return 50.</li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd>It is possible for the <code>all_durable</code> value read by the application to be obsolete by the time the application receives it and applications using this value to make operational decisions are responsible for coordinating their own actions (for example by using high-level locks) to ensure its validity. Specifically, any transaction commit with a durable timestamp (or a commit timestamp if no durable timestamp was set), larger than than the current <code>durable_timestamp</code> value will set the <code>durable_timestamp</code> to the transaction's durable (commit) timestamp. Calling the <a class="el" href="struct_w_t___c_o_n_n_e_c_t_i_o_n.html#a93dbc74accb426582b3c5c2f69e04b28" title="Rollback tables to an earlier point in time, discarding all updates to checkpoint durable tables that...">WT_CONNECTION::rollback_to_stable</a> method will reset the <code>durable_timestamp</code> to the stable timestamp.</dd>
<dd>
Reading the <code>all_durable</code> timestamp does not prevent additional prepared but uncommitted transactions from appearing if a transaction prepares, setting an earlier durable timestamp.</dd>
<dd>
The <code>all_durable</code> query is used by the MongoDB server and is generally not expected to be useful to other applications.</dd></dl>
<p>The <code>all_durable</code> timestamp is read-only.</p>
<h2><a class="anchor" id="timestamp_global_query_api_last_checkpoint"></a>
Reading the "last_checkpoint" timestamp</h2>
<p>The <code>last_checkpoint</code> timestamp is the stable timestamp of the previous checkpoint (or 0 if no checkpoints have run). This timestamp is a general case of the <code>recovery</code> timestamp. Generally, applications are expected to use the <code>recovery</code> timestamp and not the <code>last_checkpoint</code> timestamp.</p>
<p>The <code>last_checkpoint</code> timestamp is read-only.</p>
<h2><a class="anchor" id="timestamp_global_query_api_oldest_reader"></a>
Reading the "oldest_reader" timestamp</h2>
<p>The <code>oldest_reader</code> timestamp is the oldest transaction read timestamp active, including the read timestamp of any running checkpoint.</p>
<p>The <code>oldest_reader</code> timestamp is read-only.</p>
<h2><a class="anchor" id="timestamp_global_query_api_oldest_timestamp"></a>
Reading the "oldest_timestamp" timestamp</h2>
<p>The <code>oldest_timestamp</code> is the current <code>oldest_timestamp</code> as set by the application.</p>
<h2><a class="anchor" id="timestamp_global_query_api_pinned"></a>
Reading the "pinned" timestamp</h2>
<p>The <code>pinned</code> timestamp is the minimum of <code>oldest_timestamp</code> and the oldest active reader, including any running checkpoint. It is not the same as <code>oldest_timestamp</code> because the oldest timestamp can be advanced past currently active readers, leaving a reader as the earliest timestamp in the system. Applications can use the <code>pinned</code> timestamp to understand the earliest data required by any reader in the system.</p>
<p>The <code>pinned</code> timestamp is read-only.</p>
<h2><a class="anchor" id="timestamp_global_query_api_recovery"></a>
Reading the "recovery" timestamp</h2>
<p>The <code>recovery</code> timestamp is the stable timestamp to which recovery was performed on startup. Applications can use the <code>recovery</code> timestamp to retrieve the value the stable timestamp had at system startup.</p>
<p>The <code>recovery</code> timestamp is read-only.</p>
<h2><a class="anchor" id="timestamp_global_query_api_stable_timestamp"></a>
Reading the "stable_timestamp" timestamp</h2>
<p>The <code>stable_timestamp</code> is the current <code>stable_timestamp</code> as set by the application. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
