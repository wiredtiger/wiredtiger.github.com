<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Concurrency management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger11.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.3.1</span>
   </div>
   <div id="projectbrief"><!-- 11.3.1 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('arch-concurrency.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Concurrency management</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<p>WiredTiger is a multi-threaded application and needs to manage concurrent access to memory locations. Many mechanisms are defined in WiredTiger to allow for safe concurrent access to memory locations. This page describes what those mechanisms are and the intended usage of them in the code base.</p>
<h1><a class="anchor" id="volatile"></a>
Volatile</h1>
<p>WiredTiger utilizes volatile for one reason, managing compiler optimization. Leveraging the definitions from "Is Parallel Programming Hard, And, If So, What Can You Do About It?", Paul E. McKenney, WiredTiger utilizes volatile to prevent the following type of compiler optimizations: Load fusing, store fusing, invented loads, invented stores and code reordering. WiredTiger defines the following macros WT_READ_ONCE and WT_WRITE_ONCE which, if used correctly, prevent the prescribed forms of compiler optimization. Additionally some variables in WiredTiger are defined with the volatile keyword if it is known that they will be frequently accessed in a concurrent context.</p>
<h1><a class="anchor" id="locking"></a>
Locking</h1>
<p>There are two types of locks in WiredTiger:</p><ul>
<li>Mutexes</li>
<li>Read Write (RW) Locks</li>
</ul>
<h2><a class="anchor" id="lock-usage"></a>
Lock usage</h2>
<p>A correctly used lock must be held when accessing any of the shared memory locations that it protects, unless they are known to not be accessed by any other threads (e.g. you are initializing some structure that hasn't been shared yet). WiredTiger sometimes deviates from this model and reads variables outside the context of the relevant lock. Such instances are only permitted if reading inconsistent data is sufficient for the use case.</p>
<p>More details on lock hierarchy and usage can be found in the <a class="el" href="arch-locking-hierarchy.html">Locks hierarchy</a>.</p>
<h1><a class="anchor" id="generations"></a>
Generations</h1>
<p>Shared objects, including the page index, WT_REFs, etc. have their lifecycles managed using the WiredTiger generations system. In general, when a reader thread accesses an object that could be concurrently freed, it enters a "generation". After entering that generation it accesses the object. A generation is a monotonically increasing integer which denotes times at which a given object must exist.</p>
<p>Writer threads are then able to replace that object but cannot free it until the reader thread has left or released the generation. Instead the writer thread adds the object to a "stash" and it marks the stashed object with the generation indicating the point at which it was added to the stash. When no reader in the system holds a generation which is older than or equal to the stashed object's generation it can be freed.</p>
<h1><a class="anchor" id="atomics"></a>
Atomics</h1>
<p>As mentioned in <a class="el" href="portability.html">General information on portability</a> WiredTiger expects loads and stores of specific sizes to be atomic and prevent tearing. WiredTiger also relies on atomic RMW operations, these include:</p><ul>
<li>Compare and Swap</li>
<li>Fetch add / sub</li>
<li>Add / sub fetch</li>
</ul>
<h1><a class="anchor" id="memory-barriers"></a>
Memory Barriers</h1>
<p>WiredTiger utilizes memory barriers in a number of places to manage CPU instruction reordering and compiler reordering. Specifically CPUs are allowed to reorder load and store instructions. If this occurs when two threads are reading or writing to the same shared memory locations it can result in those threads seeing what would otherwise be incorrect state.</p>
<p>WiredTiger defines barriers by describing which kind of reordering they prevent, for example a LoadLoad barrier prevents load instructions before the barrier from being reordered with load instructions after the barrier. Using this definition we can define 4 types of reorderings, LoadLoad, StoreStore, LoadStore and StoreLoad. To simplify the barrier semantics further WiredTiger defines acquire and release barriers.</p>
<h2><a class="anchor" id="acq-bar"></a>
Acquire barrier</h2>
<p>The acquire barrier prevents LoadLoad and LoadStore reorderings. It is accessible through two macros.</p>
<p>Firstly <code>WT_ACQUIRE_BARRIER</code> which is a standalone barrier. This barrier enforces an ordering between all reads prior to the barrier, and all reads or writes following the barrier. Oftentimes this barrier is used to provide ordering between a single prior read and all subsequent read and writes, in which case <code>WT_ACQUIRE_READ_WITH_BARRIER</code> can be used. While <code>WT_ACQUIRE_READ_WITH_BARRIER</code> can be thought of as ordering a single read with all subsequent instructions, mechanically it is still a <code>WT_ACQUIRE_BARRIER</code> and has the same semantics. It is better to use <code>WT_ACQUIRE_READ</code> to order a single prior read, described below.</p>
<h2><a class="anchor" id="rel-bar"></a>
Release barrier</h2>
<p>The release barrier prevents StoreStore and LoadStore reorderings. <code>WT_RELEASE_BARRIER</code> behaves similarly to <code>WT_ACQUIRE_BARRIER</code>, but orders all subsequent writes against all prior reads and writes. <code>WT_RELEASE_WRITE_WITH_BARRIER</code> has a similar intent to the <code>WT_ACQUIRE_READ_WITH_BARRIER</code>. It can be thought of as ordering a single write with respect to all prior reads and writes. However it is semantically the same as the <code>WT_RELEASE_BARRIER</code>. These barriers should be used as pairs. If one location requires an acquire barrier then there must be another location that requires a release barrier. It is better to use <code>WT_RELEASE_WRITE</code> to order a single write, described below.</p>
<p>Previously WiredTiger defined a <code>WT_PUBLISH</code> macro which prevented StoreStore reordering, this macro has since been removed however the term publish still exists in the code base. The term publish is used to refer to writing a value to a shared memory location. It doesn't define any memory ordering semantics.</p>
<h2><a class="anchor" id="full-bar"></a>
Full barrier</h2>
<p>The full barrier prevents all 4 described types of reorderings and is accessible via the <code>WT_FULL_BARRIER</code> macro. It is the only way to prevent StoreLoad reordering.</p>
<h2><a class="anchor" id="com-bar"></a>
Compiler barrier</h2>
<p>The compiler barrier prevents compiler optimization and reordering across the compiler barrier. This barrier is accessed via the <code>WT_COMPILER_BARRIER</code>. It does not impact CPU reordering. Additionally all memory barriers described are also compiler barriers.</p>
<h1><a class="anchor" id="marked-access"></a>
Marked Access</h1>
<p>Barriers are a heavy hammer for situations that only need to prevent reordering of instructions on one side of a load or store. To reduce the amount of reorderings prevented WiredTiger defines two marked access macros. These are loads and stores that prevent reordering from one direction across that load or store. The macro then achieve the intended semantics of <code>WT_ACQUIRE_READ_WITH_BARRIER</code> and <code>WT_RELEASE_WRITE_WITH_BARRIER</code> without added side effects.</p>
<h2><a class="anchor" id="acq-marked"></a>
Acquire</h2>
<p><code>WT_ACQUIRE_READ</code>, this macro prevents loads and stores following the load from being reordered with it. Ensuring they happen after the marked load.</p>
<h2><a class="anchor" id="rel-marked"></a>
Release</h2>
<p><code>The</code> WT_RELEASE_WRITE macro prevents loads and stores prior to the store from being reordered with it. Ensuring the store happens after the given loads and stores. As with the acquire and release barriers these marked access macros should be paired together to function correctly. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-int-wt-dev.html">Internal WiredTiger Development</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
