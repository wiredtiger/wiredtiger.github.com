<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Commit-level durability</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger11.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.3.0</span>
   </div>
   <div id="projectbrief"><!-- 11.3.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('durability_log.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Commit-level durability</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The next level of WiredTiger transactional application involves adding commit-level durability for data modifications. As described in <a class="el" href="durability_checkpoint.html">Checkpoint-level durability</a>, WiredTiger supports checkpoint durability by default. Commit-level durability requires additional configuration.</p>
<h1><a class="anchor" id="commit_durability_enable"></a>
Enabling commit-level durability</h1>
<p>To enable commit-level durability, pass the <code>log=(enabled)</code> configuration string to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a>. This causes WiredTiger to write records into the log for each transaction, giving all objects opened in the database commit-level durability. The operational transactional API does not otherwise change.</p>
<dl class="section warning"><dt>Warning</dt><dd>By default, log records are written to an in-memory buffer before <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> returns, giving the highest performance but not ensuring immediate durability. The database can be configured to flush log records to the operating system buffer cache (ensuring durability over application failure), or to stable storage (ensuring durability over system failure), but that will impact performance. See <a class="el" href="#commit_durability_flush_config">Flush call configuration</a> for more information.</dd></dl>
<p>It is possible to enable commit-level durability for some database objects and not others. To do this, one must pass <code>"log=(enabled)"</code> to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> and then pass <code>"log=(enabled=false)"</code> to <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb">WT_SESSION::create</a> for the objects that should continue to use checkpoint durability. (Doing the converse is not supported, that is, enabling logging on some tables while leaving the global switch turned off.)</p>
<dl class="section warning"><dt>Warning</dt><dd>Making commits to both checkpoint-durable and commit-durable objects in the same transaction requires caution: if the system crashes before another checkpoint is taken, any such transaction will be torn, only the commit-durable part of it will remain and the rest will be lost. In most cases this is undesirable, however, this combination can be usefully leveraged to create application-level write-ahead logs and is therefore explicitly supported.</dd></dl>
<p>While this is rarely useful, object logging can be toggled during application restart (in other words, logging can be enabled for a table previously created or used with logging disabled, and vice-versa). Log records found during recovery are applied to the table, regardless of whether logging is currently configured for the table.</p>
<h1><a class="anchor" id="commit_durability_logs"></a>
Commit-level durability and logs</h1>
<p>Commit-level durability is implemented using a write-ahead log. When logging is enabled for an object, WiredTiger writes a record to the log for each update operating on the object. Transactions group updates, and in keeping with the principle of atomicity each transaction's updates become durable when the transaction is committed.</p>
<p>By default, log records are buffered in memory and not flushed to disk immediately, even when committed; groups of transactions are flushed together. (See <a class="el" href="#commit_durability_group_commit">Group commit</a>.) It is possible to flush transactions to disk more aggressively if desired. See <a class="el" href="#commit_durability_flush_config">Flush call configuration</a>.</p>
<h1><a class="anchor" id="commit_durability_recovery"></a>
Recovery</h1>
<p>When the transactional log is enabled, calling <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> automatically performs a recovery step when opening the database. This rolls the log forward; that is, it reapplies whatever changes from the log are required to bring the database up to date with the most recent transactional state.</p>
<p>This recovery step may require extensions be available when it runs (for example, collators and compression). Therefore, applications using commit-level durability must configure extensions with the <code>extensions</code> keyword to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> consistently whenever re-opening the database.</p>
<h1><a class="anchor" id="commit_durability_checkpoint"></a>
Checkpoints</h1>
<p>When using commit-level durability one should still perform checkpoints of the database. Database checkpoints are necessary for two reasons: First, log files can only be removed after a checkpoint completes, and so the frequency of checkpoints determines the disk space required by log files. Second, checkpoints bound the time required for recovery to complete after application or system failure by limiting the log records that need to be processed.</p>
<p>Checkpoints can be done either explicitly by the application or periodically based on elapsed time or data size with the <code>checkpoint</code> configuration to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a>. The period between checkpoint completion and the start of a subsequent checkpoint can be set in seconds via <code>wait</code>, as the number of bytes written to the log since the last checkpoint via <code>log_size</code>, or both. If both are set then the checkpoint occurs as soon as either threshold has occurred and both are reset once the checkpoint is complete. If using <code>log_size</code> to scheduled automatic checkpoints, we recommend the size selected be a multiple of the physical size of the underlying log file to more easily support automatic log file removal.</p>
<h1><a class="anchor" id="commit_durability_backup"></a>
Backups</h1>
<p>Backups are done using backup cursors (see <a class="el" href="backup.html">Backups</a> for more information).</p>
<p>With logging enabled, partial backups (backups where not all of the database objects are copied) may result in error messages during recovery, because data files referenced in the logs might not be found. Applications should either copy all objects and log files if commit-level durability of the copied database is required, or alternatively, copy only selected objects when backing up and not copy log files at all, then fall back to checkpoint durability when activating the backup.</p>
<h1><a class="anchor" id="commit_durability_archiving"></a>
Log file archival and removal</h1>
<p>WiredTiger log files are named "WiredTigerLog.[number]" where "[number]" is a 10-digit value, for example <code>WiredTigerLog.0000000001</code>. The log file with the largest number in its name is the most recent log file written. The log file size can be set using the <code>log</code> configuration to <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a>.</p>
<p>By default, WiredTiger automatically removes log files no longer required for recovery. Applications wanting to archive log files instead (for example, to support catastrophic recovery), must disable log file removal using the <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a> <code>"log=(remove=false)"</code> configuration.</p>
<p>Log files may be removed or archived after a checkpoint has completed, as long as there is no backup in progress. When performing <a class="el" href="backup.html#backup_incremental">Log-based Incremental backup</a>, <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#ac2bad195e24710d52d730fe3a7c1756a" title="Truncate a file, table, cursor range, or backup cursor.">WT_SESSION::truncate</a> can be used to remove log files after completing each incremental backup.</p>
<p>Immediately after the checkpoint has completed, only the most recent log file is needed for recovery, and all other log files can be removed or archived. Note that there must always be at least one log file for the database.</p>
<h1><a class="anchor" id="commit_log_cursors"></a>
Log cursors</h1>
<p>Applications can independently read and write WiredTiger log files for their own purposes (for example, inserting debugging records), using the standard WiredTiger cursor interfaces. See <a class="el" href="cursor_log.html">Log cursors</a> for more information.</p>
<p>Open log cursors prevent WiredTiger from automatically removing log files. Therefore, we recommend proactively closing log cursors when done with them. Applications manually removing log files should take care that no log cursors are opened in the log when removing files or errors may occur when trying to read a log record in a file that was removed.</p>
<h1><a class="anchor" id="commit_durability_bulk"></a>
Bulk loads</h1>
<p>Bulk loads are not commit-level durable, that is, the creation and bulk-load of an object will not appear in the database log files. For this reason, applications doing incremental backups after a full backup should repeat the full backup step after doing a bulk load to make the bulk load appear in the backup. In addition, incremental backups after a bulk load (without an intervening full backup) can cause recovery to report errors because there are log records that apply to data files which do not appear in the backup.   </p>
<h1><a class="anchor" id="commit_durability_tuning"></a>
Tuning commit-level durability</h1>
<h2><a class="anchor" id="commit_durability_group_commit"></a>
Group commit</h2>
<p>WiredTiger automatically groups the flush operations for threads that commit concurrently into single calls. This usually means multi-threaded workloads will achieve higher throughput than single-threaded workloads because the operating system can flush data more efficiently to the disk. No application-level configuration is required for this feature.   </p>
<h2><a class="anchor" id="commit_durability_flush_config"></a>
Flush call configuration</h2>
<p>By default, log records are written to an in-memory buffer before <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> returns, giving highest performance but not ensuring durability. The durability guarantees can be stricter but this will impact performance.</p>
<p>If <code>"transaction_sync=(enabled=false)"</code> is configured in <a class="el" href="group__wt.html#gacbe8d118f978f5bfc8ccb4c77c9e8813" title="Open a connection to a database.">wiredtiger_open</a>, log records may be buffered in memory, and only flushed to disk by checkpoints, when log files switch or calls to <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> with <code>sync=on</code>. (Note that any call to <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> with <code>sync=on</code> will flush the log records for all committed transactions, not just the transaction where the configuration is set.) This provides the minimal guarantees, but will be significantly faster than other configurations.</p>
<p>If <code>"transaction_sync=(enabled=true)"</code>, <code>"transaction_sync=(method)"</code> further configures the method used to flush log records to disk. By default, the configured value is <code>fsync</code>, which calls the operating system's <code>fsync</code> call (or <code>fdatasync</code> if available) as each commit completes.</p>
<p>If the value is set to <code>dsync</code>, the <code>O_DSYNC</code> or <code>O_SYNC</code> flag to the operating system's <code>open</code> call will be specified when the file is opened. (The durability guarantees of the <code>fsync</code> and <code>dsync</code> configurations are the same, and in our experience the <code>open</code> flags are slower; this configuration is only included for systems where that may not be the case.)</p>
<p>If the value is set to <code>none</code>, the operating system's <code>write</code> call will be called as each commit completes but no explicit disk flush is made. This setting gives durability across application failure, but likely not across system failure (depending on operating system guarantees).</p>
<p>When a log file fills and the system moves to the next log file, the previous log file will always be flushed to disk prior to close. So when running in a durability mode that does not flush to disk, the risk is bounded by the most recent log file change.</p>
<p>Here is the expected performance of durability modes, in order from the fastest to the slowest (and from the fewest durability guarantees to the most durability guarantees).</p>
<table class="doxtable">
<tr>
<th>Durability Mode</th><th>Notes </th></tr>
<tr>
<td><code>log=(enabled=false)</code></td><td>checkpoint-level durability </td></tr>
<tr>
<td><code>log=(enabled),transaction_sync=(enabled=false)</code></td><td>in-memory buffered logging configured; updates durable after checkpoint or after <code>sync</code> is set in <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a7e26b16b26b5870498752322fad790bf">WT_SESSION::begin_transaction</a> </td></tr>
<tr>
<td><code>log=(enabled),transaction_sync=(enabled=true,method=none)</code></td><td>logging configured; updates durable after application failure, but not after system failure </td></tr>
<tr>
<td><code>log=(enabled),transaction_sync=(enabled=true,method=fsync)</code></td><td>logging configured; updates durable on application or system failure </td></tr>
<tr>
<td><code>log=(enabled),transaction_sync=(enabled=true,method=dsync)</code></td><td>logging configured; updates durable on application or system failure </td></tr>
</table>
<p>The durability setting can also be controlled directly on a per-transaction basis via the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> method. The <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2">WT_SESSION::commit_transaction</a> supports several durability modes with the <code>sync</code> configuration that override the connection level settings.</p>
<p>If <code>sync=on</code> is configured then this commit operation will wait for its log records, and all earlier ones, to be durable to the extent specified by the <code>"transaction_sync=(method)"</code> setting before returning.</p>
<p>If <code>sync=off</code> is configured then this commit operation will write its records into the in-memory buffer and return immediately.</p>
<p>The durability of the write-ahead log can be controlled independently as well via the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a1843292630960309129dcfe00e1a3817">WT_SESSION::log_flush</a> method. The <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a1843292630960309129dcfe00e1a3817">WT_SESSION::log_flush</a> supports several durability modes with the <code>sync</code> configuration that immediately act upon the log.</p>
<p>If <code>sync=on</code> is configured then this flush will force the current log and all earlier records to be durable on disk before returning. This method call overrides the <code>transaction_sync</code> setting and forces the data out via <code>fsync</code>.</p>
<p>If <code>sync=off</code> is configured then this flush operation will force the logging subsystem to write any outstanding in-memory buffers to the operating system before returning, but not explicitly ask the OS to flush them.    </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
