<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Managing the transaction timestamp state</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.2.0</span>
   </div>
   <div id="projectbrief"><!-- 11.2.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('timestamp_txn_api.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Managing the transaction timestamp state </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Individual transactions also have timestamp state. These timestamps are queried using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aeec1349581b7f97fc90573550fff8b6b" title="Query the session&#39;s transaction timestamp state.">WT_SESSION::query_timestamp</a> but are potentially set in a variety of methods to allow configuration at various stages of the transaction: <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a7e26b16b26b5870498752322fad790bf" title="Start a transaction in this session.">WT_SESSION::begin_transaction</a>, <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2" title="Commit the current transaction.">WT_SESSION::commit_transaction</a>, <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a96b8a369610c8cbb08b8a7c504fd1008" title="Prepare the current transaction.">WT_SESSION::prepare_transaction</a> and <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f" title="Set a timestamp on a transaction.">WT_SESSION::timestamp_transaction</a>.</p>
<p>Applications will focus on two transactional timestamps: the read timestamp and the commit timestamp. Without a read timestamp, reads will occur based on the transaction's snapshot, which will include the latest values as of when the snapshot is taken. With a read timestamp, reads will occur as of the specified time.</p>
<p>The transaction's commit timestamp is the time at which the transaction takes effect. This is the time at which other transactions, with appropriately set read timestamps, will see the transaction's writes instead of any previous value. Applications can also set commit timestamps on a per-update basis in a single transaction, in which case the commit timestamp is the time of the visibility of the effected updates.</p>
<h1><a class="anchor" id="timestamp_txn_api_configure"></a>
Application timestamp configuration</h1>
<p>The <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a> method's <code>"assert=(read_timestamp)"</code> configuration checks that timestamps always or never be used on reads in the table.</p>
<p>By default, WiredTiger requires commit timestamps be used in "ordered" mode: updates to a table can be made both with and without a commit timestamp, but once a commit timestamp is used to update a key, all future updates to the key require a commit timestamp. Further, each update to a key must have a commit timestamp at or after the previous commit timestamp.</p>
<p>Updating a key without a commit timestamp creates a value that has "always
existed" and is visible regardless of timestamp. This makes sense when loading initial data into an object, but once timestamps are used to update a particular value, subsequent updates will normally also have a commit timestamp. Similarly, because implicit transactions have no associated timestamp, implicit transactions are generally only useful until timestamps have been used to update a table.</p>
<p>These requirements can be changed on a per-table basis, to specify no updates to a table have timestamps, with the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a> method's <code>"write_timestamp_usage=(never)"</code> configuration.</p>
<p>These requirements can be changed on a per-transaction basis, to permit updates without timestamps, after a key has already been updated using a timestamp, with the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a7e26b16b26b5870498752322fad790bf" title="Start a transaction in this session.">WT_SESSION::begin_transaction</a> method's <code>no_timestamp</code> configuration. Updating a key without a commit timestamp, after making updates with a commit timestamp, will discard all prior historical values, and future reads will read the new value regardless of read timestamp. In other words, readers with already acquired snapshots will see prior historical values based on their timestamps. Readers acquiring a snapshot after the commit of the update without a timestamp will not see prior historical values regardless of their read timestamps.</p>
<p>There are additional timestamp usage checks in diagnostic builds. Building in diagnostic mode to enable these usage checks will decrease application performance. While applications should not configure diagnostic builds for production use, they are strongly recommended during development.</p>
<p>If WiredTiger detects a violation of timestamp policy, an error message will be logged and the transaction commit will fail. In diagnostic builds, the library will log an error message and drop core at the failing check.</p>
<dl class="section warning"><dt>Warning</dt><dd>These are best-effort checks by WiredTiger, and there are cases where application misbehavior will not be detected.</dd></dl>
<h1><a class="anchor" id="timestamp_txn_api_commit_timestamp"></a>
Setting the transaction's commit timestamp</h1>
<p>The <code>commit</code> time is the time at which other transactions with appropriately set read timestamps will see the transaction's updates.</p>
<p>The commit timestamp can be set at any point in the transaction's lifecycle. For prepared transactions, however, it can only be set after the transaction has been successfully prepared.</p>
<dl class="section warning"><dt>Warning</dt><dd>Commit (and prepare) timestamps must not be set in the past of any read timestamp that has ever been used. This rule is enforced by assertions in diagnostic builds, but if applications violate this rule in non-diagnostic builds, data consistency can be violated. Similarly, because reading without a read timestamp reads the latest values for all keys, one must not commit into the past of such a transaction.</dd></dl>
<p>Applications using timestamps usually specify a timestamp to the <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2" title="Commit the current transaction.">WT_SESSION::commit_transaction</a> method to set the commit time for all updates in the transaction.</p>
<p>For prepared transactions, the commit timestamp must not be before the prepare timestamp. Otherwise, the commit timestamp must be after the stable timestamp.</p>
<h1><a class="anchor" id="timestamp_txn_api_commit_multi_timestamp"></a>
Setting multiple commit timestamps</h1>
<p>Applications may set different commit timestamps for different updates in a single transaction by calling <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f" title="Set a timestamp on a transaction.">WT_SESSION::timestamp_transaction</a> repeatedly to set a new commit timestamp between updates in the transaction. Each new commit timestamp is applied to any subsequent updates. This gives applications the ability to commit updates that take effect at different times; that is, it is possible to create chains of updates where each update appears at a different time to readers. For transactions that set multiple commit timestamps, the first commit timestamp set is also required to be the earliest: the second and subsequent commit timestamps may not be earlier than the first commit timestamp. This feature is not compatible with prepared transactions, which must use only a single commit timestamp.</p>
<p>This functionality is generally available as a mechanism to allow an optimized implementation of re-creating a timestamp view of a data set. For example, in a MongoDB replica set, content is generated on one node where transactions are assigned a single commit timestamp, that content is re-created on each other member in a replica set. When re-creating the content multiple changes from the original node are batched together into a single WiredTiger transaction.</p>
<h1><a class="anchor" id="timestamp_txn_api_read_timestamp"></a>
Setting the transaction's read timestamp</h1>
<p>Setting the transaction's read timestamp causes a transaction to not see any commits with a newer timestamp. (Updates may still conflict with commits having a newer timestamp, of course.),</p>
<p>The read timestamp may be set to any time equal to or after the system's <code>oldest</code> timestamp.</p>
<p>This restriction is enforced and applications can rely on an error return to detect attempts to set the read timestamp older than the <code>oldest</code> timestamp.</p>
<p>The read timestamp may only be set once in the lifetime of a transaction.</p>
<h1><a class="anchor" id="timestamp_txn_api_query"></a>
Querying transaction timestamp information</h1>
<p>The following table lists the timestamps that can be queried using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aeec1349581b7f97fc90573550fff8b6b" title="Query the session&#39;s transaction timestamp state.">WT_SESSION::query_timestamp</a>. In all cases, a timestamp of 0 is returned if the timestamp is not available or has not been set, for example, the <code>commit</code> timestamp if no commit timestamp has been set.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">commit </td><td class="markdownTableBodyNone">the transaction's most recently set commit timestamp  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">first_commit </td><td class="markdownTableBodyNone">the transaction's first/earliest set commit timestamp  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">prepare </td><td class="markdownTableBodyNone">the timestamp used to prepare the transaction  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">read </td><td class="markdownTableBodyNone">the timestamp at which the transaction is reading  </td></tr>
</table>
<h1><a class="anchor" id="timestamp_txn_api_begin"></a>
Configuring transaction timestamp information with WT_SESSION::begin_transaction</h1>
<p>The following table lists the transaction's timestamps and behaviors that can be set when the transaction begins, using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a7e26b16b26b5870498752322fad790bf" title="Start a transaction in this session.">WT_SESSION::begin_transaction</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraint </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">read_timestamp </td><td class="markdownTableBodyNone">&gt;= oldest </td><td class="markdownTableBodyNone">the transaction's read timestamp, see <a class="el" href="timestamp_txn_api.html#timestamp_txn_api_read_timestamp">Setting the transaction's read timestamp</a> for details  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">roundup_timestamps </td><td class="markdownTableBodyNone">None </td><td class="markdownTableBodyNone">boolean setting for timestamp auto-adjustments, see <a class="el" href="timestamp_prepare_roundup.html">Automatic prepare timestamp rounding</a> and <a class="el" href="timestamp_misc.html#timestamp_read_roundup">Rounding up the read timestamp</a> for details  </td></tr>
</table>
<h1><a class="anchor" id="timestamp_txn_api_commit"></a>
Configuring transaction timestamp information with WT_SESSION::commit_transaction</h1>
<p>The following table lists the transaction's timestamps that can be set when the transaction commits, using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a712226eca5ade5bd123026c624468fa2" title="Commit the current transaction.">WT_SESSION::commit_transaction</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraint </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">commit_timestamp </td><td class="markdownTableBodyNone">&gt; stable and &gt;= prepare and &gt;= any system read timestamp </td><td class="markdownTableBodyNone">the transaction's commit timestamp, see <a class="el" href="timestamp_txn_api.html#timestamp_txn_api_commit_timestamp">Setting the transaction's commit timestamp</a> for details  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">durable_timestamp </td><td class="markdownTableBodyNone">&gt;= commit </td><td class="markdownTableBodyNone">the transaction's durable timestamp, only applicable to prepared transactions, see <a class="el" href="timestamp_prepare.html">Using transaction prepare with timestamps</a> for details  </td></tr>
</table>
<h1><a class="anchor" id="timestamp_txn_api_prepare"></a>
Configuring transaction timestamp information with WT_SESSION::prepare_transaction</h1>
<p>The following table lists the transaction's timestamps that can be set when the transaction is prepared, using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a96b8a369610c8cbb08b8a7c504fd1008" title="Prepare the current transaction.">WT_SESSION::prepare_transaction</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraint </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">prepare_timestamp </td><td class="markdownTableBodyNone">&gt; stable and &gt;= any system read timestamp </td><td class="markdownTableBodyNone">the transaction's prepare timestamp, see <a class="el" href="timestamp_prepare.html">Using transaction prepare with timestamps</a> for details  </td></tr>
</table>
<h1><a class="anchor" id="timestamp_txn_api_timestamp_transaction"></a>
Configuring transaction timestamp information with WT_SESSION::timestamp_transaction</h1>
<p>The following table lists the transaction's timestamps that can be set at other points in the transaction's lifetime, using <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aa449082ce4de7ee86a773595c416a69f" title="Set a timestamp on a transaction.">WT_SESSION::timestamp_transaction</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Timestamp </th><th class="markdownTableHeadNone">Constraint </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">commit_timestamp </td><td class="markdownTableBodyNone">&gt; stable and &gt;= prepare and &gt;= any system read timestamp </td><td class="markdownTableBodyNone">the transaction's commit timestamp, see <a class="el" href="timestamp_txn_api.html#timestamp_txn_api_commit_timestamp">Setting the transaction's commit timestamp</a> for details  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">durable_timestamp </td><td class="markdownTableBodyNone">&gt;= commit </td><td class="markdownTableBodyNone">the transaction's durable timestamp, only applicable to prepared transactions, see <a class="el" href="timestamp_prepare.html">Using transaction prepare with timestamps</a> for details  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">prepare_timestamp </td><td class="markdownTableBodyNone">&gt; stable and &gt;= any system read timestamp </td><td class="markdownTableBodyNone">the transaction's prepare timestamp, see <a class="el" href="timestamp_prepare.html">Using transaction prepare with timestamps</a> for details  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">read_timestamp </td><td class="markdownTableBodyNone">&gt;= oldest </td><td class="markdownTableBodyNone">the transaction's read timestamp, see <a class="el" href="timestamp_txn_api.html#timestamp_txn_api_read_timestamp">Setting the transaction's read timestamp</a> for details  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="programming.html">Writing WiredTiger applications</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
