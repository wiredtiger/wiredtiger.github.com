<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>WiredTiger: Block Manager</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="sorttable.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="wiredtiger.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://wiredtiger.com/"><img alt="Logo" src="LogoFinal-header.png" alt="WiredTiger" /></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Version 11.2.0</span>
   </div>
   <div id="projectbrief"><!-- 11.2.0 --></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="banner">
  <a href="https://github.com/wiredtiger/wiredtiger">Fork me on GitHub</a>
  <a class="last" href="http://groups.google.com/group/wiredtiger-users">Join my user group</a>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('arch-block.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Block Manager </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="arch_head"><table class="doxtable">
<tr>
<th rowspan="2" style="width:10%;"> <div><a href="arch-index.html"><img class="arch_thumbnail" src="wt_diagram.png" usemap="#wt_diagram_map" style="background-image: url(wt_diagram.png)"></a></div></th><th style="width:44%">Data Structures</th><th style="width:45%">Source Location</th></tr>
<map id="wt_diagram_map" name="wt_diagram_map">
<area shape="rect" id="id1" href="modules.html" title="modules.html" alt="" coords="248,128,283,144"/>
<area shape="rect" id="id2" href="arch-cache.html" title="arch-cache.html" alt="" coords="204,546,248,562"/>
<area shape="rect" id="id3" href="arch-cursor.html" title="arch-cursor.html" alt="" coords="234,224,280,240"/>
<area shape="rect" id="id4" href="arch-eviction.html" title="arch-eviction.html" alt="" coords="303,546,356,562"/>
<area shape="rect" id="id5" href="arch-logging.html" title="arch-logging.html" alt="" coords="388,650,443,666"/>
<area shape="rect" id="id6" href="arch-schema.html" title="arch-schema.html" alt="" coords="123,224,179,240"/>
<area shape="rect" id="id7" href="command_line.html" title="command_line.html" alt="" coords="374,23,430,39"/>
<area shape="rect" id="id8" href="arch-log-file.html" title="arch-log-file.html" alt="" coords="308,865,339,897"/>
<area shape="rect" id="id9" href="arch-metadata.html" title="arch-metadata.html" alt="" coords="25,328,89,344"/>
<area shape="rect" id="id10" href="arch-python.html" title="arch-python.html" alt="" coords="84,23,157,39"/>
<area shape="rect" id="id11" href="arch-snapshot.html" title="arch-snapshot.html" alt="" coords="297,441,371,457"/>
<area shape="rect" id="id12" href="arch-transaction.html" title="arch-transaction.html" alt="" coords="298,328,387,344"/>
<area shape="rect" id="id13" href="arch-hs.html" title="arch-hs.html" alt="" coords="93,642,140,674"/>
<area shape="rect" id="id14" href="arch-block.html" title="arch-block.html" alt="" coords="196,642,256,674"/>
<area shape="rect" id="id15" href="arch-dhandle.html" title="arch-dhandle.html" alt="" coords="144,320,205,352"/>
<area shape="rect" id="id16" href="arch-data-file.html" title="arch-data-file.html" alt="" coords="179,865,245,897"/>
<area shape="rect" id="id17" href="arch-row-column.html" title="arch-row-column.html" alt="" coords="117,433,205,465"/>
<area shape="rect" id="id18" href="arch-fs-os.html" title="arch-fs-os.html" alt="" coords="175,755,357,771"/>
</map>
<tr>
<td><code><code>WT_BLOCK<br  />
WT_BLOCK_CKPT<br  />
WT_BLOCK_DESC<br  />
WT_BLOCK_HEADER<br  />
WT_BM<br  />
WT_EXTLIST</code></code></td><td><code><code>src/include/block.h<br  />
src/include/block_inline.h<br  />
src/block/</code></code></td></tr>
</table>
</div><p> <b>Caution: the Architecture Guide is not updated in lockstep with the code base and is not necessarily correct or complete for any specific release.</b></p>
<p>The WiredTiger block manager subsystem manages the reading and writing of data from the disk. It is designed to facilitate high performance, economic use of disk space and customizability.</p>
<h1><a class="anchor" id="block"></a>
What is a block?</h1>
<p>A block is a chunk of data that is stored on the disk and operated on as a single unit. Each WiredTiger data file (any file in the home directory with the <code></code>.wt suffix) is made up of these blocks. Each block consists of a page header, a block header and contains a single page of the btree from which it was generated. WiredTiger is a no-overwrite storage engine, and when blocks are re-written, they are written to new locations in the file. The size of a block is a multiple of the allocation size which is set during creation of the associated WiredTiger data file see: <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a>.</p>
<p>Once a block is written an address cookie is returned. This address cookie is stored as the <code>addr</code> on the associated page ref. The <code>WT_REF</code> structure can be found in <code>btmem.h</code>. The address cookie is opaque to other parts of the system and cannot be interpreted meaningfully.</p>
<p>The address cookie is made up of 4 components:</p><ul>
<li>offset: The offset in the file. In order to avoid storing large offsets this value is divided by the allocation size.</li>
<li>file_id: Optional and only relevant to the tiered storage type, the file_id is maintained in the address.</li>
<li>size: The size of the block, also divided by the allocation size.</li>
<li>checksum: The checksum of the block for validation purposes.</li>
</ul>
<p>The block header contains the following fields:</p><ul>
<li>size: The size of the block on disk, used when salvaging data from a corrupt file.</li>
<li>checksum: The checksum of the block, again used for salvaging.</li>
<li>flags: Flags set on the block itself.</li>
<li>padding</li>
</ul>
<p>The page header is not described in this document but can be found in <code>btmem.h</code>.</p>
<h1><a class="anchor" id="block_implementation"></a>
Block manager implementation details</h1>
<h2><a class="anchor" id="write_once"></a>
Writing</h2>
<p>The block manager decides where in the file a block will be written. It has two forms of writing modes, "first fit" and "best fit". The default behavior is best fit. While operating in best fit mode the block manager will search a skip list of extents sorted by size, returning either an exact match or the next largest. This is done to avoid fragmenting the file when possible. In first fit mode the block manager will place the newly created block in the first available extent. First fit mode is used for all root pages.</p>
<p>Additionally the block manager is a no-overwrite system. As such once a block is written it cannot be modified. This is for crash recovery reasons, because if the system were to crash during an overwrite the block state would be unknown. This doesn't mean that the associated page cannot be modified, once the associated page is modified a subsequent reconciliation will result in a new block being created.</p>
<h2><a class="anchor" id="desc_block"></a>
Descriptor blocks</h2>
<p>A file is divided up into blocks. The first block in a file is special as it contains metadata about the file and is referred to as the "descriptor block". It contains the WiredTiger major and minor version, a checksum of the block contents as well as a "magic" number to check against.</p>
<p>The descriptor block serves as a safety check to ensure that the file being loaded into the block manager is actually a WiredTiger data file, that it belongs to a compatible version of WiredTiger and that the entire file has not been corrupted. WiredTiger also uses checksums to defend against file corruption which is described in the <a class="el" href="arch-block.html#checksum">Checksum</a> section.</p>
<h2><a class="anchor" id="block_lists"></a>
Extent lists</h2>
<p>Internally, the block manager uses a data structure called an extent list or a <code>WT_EXTLIST</code> to track file usage. An extent list consists of a series of extents (or <code>WT_EXT</code> elements). Each extent uses a file offset and size to track a portion of the file.</p>
<p>There are three extent lists that are maintained per checkpoint:</p>
<ul>
<li><code>alloc:</code> The file ranges allocated for a given checkpoint.</li>
<li><code>avail:</code> The file ranges that are unused and available for allocation.</li>
<li><code>discard:</code> The file ranges freed in the current checkpoint.</li>
</ul>
<p>The alloc and discard extent lists are maintained as a skiplist sorted by file offset. The avail extent list also maintains an extra skiplist sorted by the extent size to aid with allocating new blocks.</p>
<h1><a class="anchor" id="configuration"></a>
Configuration options</h1>
<p>There are a number of configuration options that affect the block manager's behavior. This does not aim to be an exhaustive list, however, these are the configuration options that are more commonly of interest to developers.</p>
<p>All of the configuration options below are passed into the <code><a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a></code> API at the time of file creation.</p>
<h2><a class="anchor" id="alloc_size"></a>
Allocation size</h2>
<p>The allocation_size configuration controls the file unit allocation_size. Any blocks allocated by the block manager must be a multiple of this value.</p>
<p>For example, if we specify an allocation_size of <code>4KB</code>, blocks of size <code>8KB</code> and <code>12KB</code> would be permitted but NOT <code>10KB</code>. The allocation_size is set to <code>4KB</code> by default which is a good choice unless the OS or storage device has special requirements.</p>
<h2><a class="anchor" id="checksum"></a>
Checksum</h2>
<p>The <code>checksum</code> "on" configuration can be provided during creation of the file. This configuration instructs the block manager to checksum the full length of the buffer provided to be written into the block. Be default it is enabled. When disabled the block manager still does perform a checksum operation but only the first 64 bytes of the buffer are included.</p>
<p>The checksum is used when reading blocks to validate their contents, it is compared with the checksum extracted from the address cookie and it is compared with a checksum generated from the buffer that was held in the block being read. In both cases the checksum has to match.</p>
<p>There are other options that can be provided for this configuration option, they are not discussed here.</p>
<h1><a class="anchor" id="block_usage"></a>
How WiredTiger uses the block manager</h1>
<h2><a class="anchor" id="creation"></a>
File creation and the block manager</h2>
<p>When a new file is created in WiredTiger via <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#a358ca4141d59c345f401c58501276bbb" title="Create a table, column group, index or file.">WT_SESSION::create</a>, the file is created on disk and the associated <code>allocation_size</code> is written out to the metadata file. However the block manager itself only exists on the btree structure and is allocated when opening a closed btree.</p>
<h2><a class="anchor" id="read"></a>
Reading files and pages</h2>
<p>When an existing btree is opened for the first time, the location of the root block is contained in the metadata file <code>WiredTiger.wt</code>. The block manager will read the block at the location specified and return the page image as a buffer to the layer above. This will then be instantiated as a page in memory.</p>
<p>From there subsequent page addresses can be read from the root page and the process repeated as required. If a cursor traverses to a page which hasn't been read into memory the same process will take place.</p>
<h2><a class="anchor" id="Writing"></a>
Writing</h2>
<p>Two cases exist for writing out data using the block manager: checkpoint and eviction. When a page image is written out the block manager the <code>bm-&gt;write</code> API is called. See <code>bt_io.c</code> for more detail.</p>
<h3><a class="anchor" id="Checkpoint"></a>
Checkpoint</h3>
<p>For details on checkpoint at the WiredTiger level see: <a class="el" href="arch-checkpoint.html">Checkpoint</a>.</p>
<p>At the block manager level, a checkpoint corresponds with a set of blocks that are stored in the file associated with the given URI. Typically each file will contain a minimum of two checkpoints. Upon opening an existing file the most recent checkpoint is read.</p>
<p>During a checkpoint new blocks are only written out for dirty pages. A block can be included in multiple checkpoints. Assuming a page <code>X</code> is dirty and gets checkpointed in checkpoint <code>A</code>, it will be created as a new block on disk. Now the same page <code>X</code> isn't modified and another checkpoint is taken. The page is clean and as such will not require a new block to be written for it. The address of the original block is still valid.</p>
<p>Checkpoints are created in depth first order, leaf blocks are created, then the parent blocks. This is a requirement as the parent blocks contain the addresses of the leaf blocks.</p>
<p>The block manager doesn't guarantee that calling <code>bm-&gt;write</code> will result in the data being flushed to disk. In the checkpoint scenario WiredTiger will also call <code>bm-&gt;sync</code> once all blocks have been written which will call the file system dependent flush function.</p>
<p>Checkpoint deletion and merging *</p>
<p>As a checkpoint progresses it takes a snapshot of the three extent lists kept by the block manager, these extent lists are written out to disk as part of the checkpoint in blocks. Between checkpoints these extent lists are being updated via normal operation of WiredTiger.</p>
<p>Suppose we have a checkpoint <code>A</code>, which has an alloc list which contains 3 blocks <code>I</code>, <code>J</code>, <code>K</code> as such its extent lists are as follows:</p>
<p>Alloc: <code>I</code>, <code>J</code>, <code>K</code> Avail: <code>L</code>, <code>M</code> Discard: Empty</p>
<p>A second checkpoint <code>B</code> completes and has removed a page which corresponds with block <code>J</code>, it also has allocated an additional block <code>L</code>.</p>
<p>Checkpoint <code>B's</code> extent lists are as follows: Alloc: <code>L</code> Avail: <code>M</code> Discard: <code>J</code> </p>
<p>Finally we complete a 3rd checkpoint <code>C</code> which allocates an additional block <code>M</code>. Upon completion of this checkpoint we are able to remove checkpoint <code>A</code>, to do that, the block manager will merge checkpoint <code>A's</code> extent lists into checkpoint <code>B's</code>.</p>
<p>What's important here is that if a block appears in both the alloc list and the discard list it can be freed which means it goes on the avail list.</p>
<p>Which gives us the following lists for checkpoint <code>C:</code> Alloc: <code>M</code> Avail: Empty Discard: Empty</p>
<p>And the following lists for checkpoint <code>B:</code> Alloc: <code>I</code>, <code>K</code>, <code>L</code> Avail: <code>J</code> Discard: Empty</p>
<p>These extent lists are written out with the checkpoint <code>C</code>. Anything on the avail list is considered free space and can be reused as of the completion of checkpoint <code>C</code>.</p>
<p>We don't want to list each block individually in the extent lists, so instead of listing each block separately in the list, we use extents, which can describe a range in the file, that is, any number of contiguous blocks.</p>
<h3><a class="anchor" id="Eviction"></a>
Eviction</h3>
<p>For more detail on how WiredTiger eviction works see: <a class="el" href="arch-eviction.html">Eviction</a>.</p>
<p>Eviction also utilizes the block manager. When a page is evicted and contains data that needs to be maintained, logically a block needs to be written. Eviction calls <code>bm-&gt;write</code> however it does not instruct the block manager to sync the data.</p>
<h2><a class="anchor" id="Compaction"></a>
Compaction</h2>
<p>As new blocks are written, the block manager will place them where they fit best. Because of this it's common that removal of data will not result in the file shrinking. The file can only be shrunk when there are available blocks at the end of the file.</p>
<p>To manage this, WiredTiger provides a compaction API call <a class="el" href="struct_w_t___s_e_s_s_i_o_n.html#aafa7a12a4891a5bfdc98673a5b8f9c69" title="Compact a live row- or column-store btree or LSM tree.">WT_SESSION::compact</a>. The block manager operates in first fit mode during compaction to maximize block movement towards the beginning of the file. WiredTiger walks the btree and asks the block manager if relocating that page will reduce the file size. If so, the page is marked dirty, forcing the block to be rewritten. WiredTiger then performs two checkpoints, as at least two checkpoints are required to delete the checkpoint originally containing the block.</p>
<p>For more details about the compaction process, please refer to <a class="el" href="arch-compact.html">Compaction</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Reference Guide</a></li><li class="navelem"><a class="el" href="arch-index.html">WiredTiger Architecture Guide</a></li><li class="navelem"><a class="el" href="arch-toc-mem-disk.html">Moving Data Between Memory and Disk</a></li>
    <li class="footer">Copyright (c) 2008-present MongoDB, Inc.  All rights reserved.  Contact <a href="mailto:info@wiredtiger.com">info@wiredtiger.com</a> for more information.</li>
  </ul>
</div>
</body>
</html>
